<template>

    <div class="vc-spinner-group vc-fg1-border vc-unselectable">
        <label class="vc-spinner-label"></label>
        <div class="vc-spinner-spinner vc-bg4">
            <div class="vc-spinner-control vc-fg1-hoverable vc-spinner-controlDown">
                <i class="material-icons">remove_circle_outline</i>
            </div>
            <input class="vc-spinner-input vc-fg1-border" type="number">
            <div class="vc-spinner-control vc-fg1-hoverable vc-spinner-controlUp">
                <i class="material-icons">add_circle_outline</i>
            </div>
        </div>
        <span class="vc-spinner-inputBar"></span>
    </div>

</template>

<script>
    vcomet.element("vc-spinner", "vc-spinner.css", {
        themed: true,
        properties: {
            /*
              @property {String} name 
              @description spinner name
            */
            name: {
                value: "",
                reflect: true
            },
            /*
              @property {Number} value 
              @description spinner value
              default: 0
            */
            value: {
                value: 0,
                reflect: true
            },
            /*
              @property {String} placeholder 
              @description spinner placeholder
            */
            placeholder: {
                value: "",
                reflect: true
            },
            /*
              @property {String} label 
              @description spinner label
            */
            label: {
                value: "",
                reflect: true
            },
            /*
              @property {String} width 
              @description spinner size respect to container
              Value must be number with px or percentage
            */
            width: {
                value: "",
                reflect: true
            },
            /*
              @property {Boolean} disabled 
              @description Spinner deactivation
              Default: false
            */
            disabled: {
                value: false,
                reflect: true
            },
            /*
              @property {Boolean} autofocus 
              @description Spinner automatically get focus when page loads
              Default: false
            */
            autofocus: {
                value: false,
                reflect: true
            },
            /*
              @property {Number} max 
              @description Spinner maximum number value
              Value must be int number
              Default: valueless
            */
            max: {
                value: "",
                reflect: true
            },
            /*
              @property {Number} min 
              @description Spinner minimum number value
              Value must be int number
              Default: valueless
            */
            min: {
                value: "",
                reflect: true
            }
        },

        privateProperties: {
            /*
              @property (private) {String} _formelement 
              @description Set that spinner is a form element
              Value: spinner
            */
            formelement: {
                value: "spinner"
            },
            /*
              @property (private) {String} _currentValue
              @description Current textarea value
            */
            currentValue: {
                value: ""
            },
            /*
              @property (private) {Object} _callUpdateEvent
              @description Store spinner call update spinner event
            */
            callUpdateEvent: {
                value: {}
            },
            /*
              @property (private) {Object} _focusEvent
              @description Store spinner focus spinner event
            */
            focusEvent: {
                value: {}
            },
            /*
              @property (private) {Object} _refs 
              @description Object with  references
            */
            refs: {
                value: {}
            }
        },
        privateFunctions: {
            /*
              @function (private) _createRefs
              @description Creates fast access to elements
            */
            createRefs: function () {
                var el = this;

                el._refs.spinner = el.template.querySelector(".vc-spinner-spinner");
                el._refs.input = el.template.querySelector(".vc-spinner-input");
                el._refs.label = el.template.querySelector(".vc-spinner-label");
            },
            /*
              @function (private) _setValue
              @description Set new spinner value
              @param {String} newVal [new spinner value]
            */
            setValue: function () {
                var el = this;

                if (el.value) {
                    el.__value = this._checkMin(el.value);
                    el.__value = this._checkMax(el.value);

                    el._refs.input.value = el.value;
                    el._currentValue = el.value;
                    vcomet.triggerCallback("onChange", el);
                }
            },
            /*
              @function (private) _updateDisabled
              @description Update disabled status and activates the focus listeners when it is not disabled
            */
            updateDisabled: function () {
                var spinnerGroup = this.querySelector(".vc-spinner-group");
                var controlDown = this.querySelector(".vc-spinner-controlDown");
                var controlUp = this.querySelector(".vc-spinner-controlUp");

                if (!vcomet.util.isTrue(this.disabled)) {
                    this._refs.input.removeAttribute("disabled");
                    spinnerGroup.classList.remove("vc-spinner-disabled", "vc-fg1-disabled");
                    controlUp.classList.remove("vc-fg1-disabled");
                    controlUp.classList.add("vc-fg1-hoverable");
                    controlDown.classList.remove("vc-fg1-disabled");
                    controlDown.classList.add("vc-fg1-hoverable");
                    this._refs.input.classList.remove("vc-fg1-disabled");
                    this._refs.input.classList.add("vc-fg1-border");
                    this._refs.label.classList.remove("vc-fg1-disabled");
                    this._setFocusingListeners();
                    this._setUpdateListeners();

                } else {
                    this._refs.input.setAttribute("disabled", "true");
                    spinnerGroup.classList.add("vc-spinner-disabled", "vc-fg1-disabled");
                    controlUp.classList.add("vc-fg1-disabled");
                    controlUp.classList.remove("vc-fg1-hoverable");
                    controlDown.classList.add("vc-fg1-disabled");
                    controlDown.classList.remove("vc-fg1-hoverable");
                    this._refs.input.classList.add("vc-fg1-disabled");
                    this._refs.input.classList.remove("vc-fg1-border");
                    this._refs.label.classList.add("vc-fg1-disabled");
                    this._removeUpdateListeners();
                    document.body.removeEventListener("click", this._focusEvent, false);
                }

            },

            /*
              @function (private) _updateSpinner
              @description Update spinner value
              @param {Object} event [mouse event]
            */
            updateSpinner: function (event) {
                var el = this;
                var value = parseInt(el._refs.input.value);
                var control = event.target.parentNode;

                if (event.type == "click") {

                    (control.classList.contains("vc-spinner-controlDown")) ? value-- : null;
                    (control.classList.contains("vc-spinner-controlUp")) ? value++ : null;

                }

                value = el._checkMin(value);
                value = el._checkMax(value);
                el.value = value;
                el._refs.input.value = value;
                el._refs.input.setAttribute("value", value);

            },

            /*
            @function (private) _setFocusingListeners
            @description Set listener for focus and blur
            */
            setFocusingListeners: function () {
                var el = this;
                vcomet.registerPathListener(el._refs.spinner);

                document.body.addEventListener("click", focusEvent, false);
                el._focusEvent = focusEvent;

                function focusEvent() {
                    (el._refs.spinner.isOnPath == true) ? el._inputFocus() : el._inputBlur(event);
                }
            },

            /*
            @function (private) _setFocusingListeners
            @description Set listener for update the spinner value
            */
            setUpdateListeners: function () {
                var el = this;
                var controlDown = el.querySelector(".vc-spinner-controlDown");
                var controlUp = el.querySelector(".vc-spinner-controlUp");

                // Click listener to control decrement spinner value
                controlDown.addEventListener("click", callUpdateEvent, false);

                // Click listener to control increment spinner value
                controlUp.addEventListener("click", callUpdateEvent, false);

                // Change listener to control spinner value change from the input
                el._refs.input.addEventListener("change", callUpdateEvent, false);

                // Handle the invalids keys in the input
                el._refs.input.addEventListener("keydown", function (event) {
                    var keysComprobation = (event.keyCode != "9" && event.keyCode != "46" && event.keyCode != "8" && event.keyCode != "38" && event.keyCode != "40" && isNaN(parseInt(event.key)));

                    keysComprobation ? event.preventDefault() : null;
                    keysComprobation ? event.stopPropagation() : null;

                    // Checks if the key press corresponds to ENTER
                    if (event.keyCode == 13) {
                        vcomet.triggerCallback("onEnter", el)
                    }

                });

                el._callUpdateEvent = callUpdateEvent;

                function callUpdateEvent(e) {
                    el._updateSpinner(e);
                }

            },

            /*
            @function (private) _removeUpdateListeners
            @description Remove listener for update the spinner value
            */
            removeUpdateListeners: function () {

                var el = this;
                var controlDown = el.querySelector(".vc-spinner-controlDown");
                var controlUp = el.querySelector(".vc-spinner-controlUp");

                // Click listener to control decrement spinner value
                controlDown.removeEventListener("click", el._callUpdateEvent, false);

                // Click listener to control increment spinner value
                controlUp.removeEventListener("click", el._callUpdateEvent, false);

                // Change listener to control spinner value change from the input
                el._refs.input.removeEventListener("change", el._callUpdateEvent, false);

            },

            /*
            @function (private) _inputFocus
            @description Set focus functionality to spinner element and to spinner input
            */
            inputFocus: function () {
                var inputBar = this.querySelector(".vc-spinner-inputBar");
                this._refs.label.classList.add("vc-spinner-focusLabel", "vc-fg1");
                inputBar.classList.add("vc-spinner-animate");
            },

            /*
            @function (private) _inputBlur
            @description Set blur functionality to spinner element and to spinner input
            */
            inputBlur: function (event) {
                var inputBar = this.querySelector(".vc-spinner-inputBar");

                this._updateSpinner(event);
                this._refs.label.classList.remove("vc-spinner-focusLabel", "vc-fg1");
                // this.value = this._refs.input.value;
                inputBar.classList.remove("vc-spinner-animate");

                // Trigger onChange callback
                this._currentValue = (this.value !== this._currentValue) ? this.value : this._currentValue;
                (this.value !== this._currentValue) ? vcomet.triggerCallback("onChange", this) : null;

            },

            /*
            @function (private) _setAutofocus
            @description Gives autofocus to the spinner
            */
            setAutofocus: function () {

                if (vcomet.util.isTrue(this.autofocus) && this.disabled == false) {
                    this._refs.input.focus();
                    this._inputFocus();
                }

            },

            /*
            @function (private) {Number} _checkMin
            @description Check that value is not less than minimum
            @param {Number} value [spinner value]
            */
            checkMin: function (value) {
                var el = this;
                var returnValue;

                returnValue = (this.min && parseInt(value) < parseInt(this.min)) ? parseInt(this.min) : value;

                return returnValue;

            },

            /*
            @function (private) {Number} _checkMax
            @description Check that value is not greater than maximum
            @param {Number} value [spinner value]
            */
            checkMax: function (value) {
                var el = this;
                var returnValue;

                returnValue = (this.max && value > this.max) ? parseInt(this.max) : value;

                return returnValue;

            }
        },

        onCreated: function () {
            var el = this;
            vcomet.createCallback("onChange", this);
            vcomet.createCallback("onEnter", this);

            el._createRefs();
        },

        onRender: function () {
            var el = this;

            // Sets a default value set by the user
            el._setValue();

            el._updateDisabled();
            el._setAutofocus();

            // Sets the name of the input
            el._refs.input.setAttribute("name", el.name);

            // Set label
            if (el.label) {
                el._refs.label.innerHTML = el.label ? el.label : el._refs.label.innerHTML;
                el._refs.label.classList.add("vc-spinner-labelDisplay");
            }

            // Sets the width of the spinner
            el.style.width = el.width;

        },

        onPropertyChanged: function (attrName, oldVal, newVal) {
            switch (attrName) {
                case "disabled":
                    this._updateDisabled();
                    break;
                case "autofocus":
                    this._setAutofocus();
                    break;
                case "label":
                    this._refs.label.innerHTML = newVal;
                    break;
                case "value":
                    this._setValue();
                    break;
            }
        }

    });

</script>