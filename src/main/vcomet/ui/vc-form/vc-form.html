<template></template>
<script>
  vcomet.element("vc-form", null, {
    properties: {
      /*
        @property {String} querySeparator 
        @description Set query separator
      */
      querySeparator: {
        value: "?",
        reflect: true
      },
      /*
        @property {String} paramSeparator 
        @description Set param separator
      */
      paramSeparator: {
        value: "&",
        reflect: true
      },
      /*
        @property {String} type 
        @description Set form type
      */
      type: {
        value: "html",
        reflect: true
      },
      /*
        @property {String} url 
        @description Set where to send form data
      */
      url: {
        value: "",
        reflect: true
      },
      /*
        @property {String} action 
        @description Same as url, respecting html standard
      */
      action: {
        value: "",
        reflect: true
      },
      /*
        @property {String} method 
        @description Set how send form data
      */
      method: {
        value: "",
        reflect: true
      }
    },
    privateFunctions: {

      walkRecursive: function (original, node, fn) {
        original = original || this;
        node = node || this;

        if (!node._formElement) {
          var children = node.childNodes; // node.children could probably increase performance
          for (var i = 0; i < children.length; i++) {
            original._walkRecursive(original, children[i], fn);
          }
        }
        fn(node);
      },

      /*
        @function (private) {String} _generateParams
        @description Return an string of form data for ajax request
        @param {Object} data [Form data]
      */
      generateParams: function (data) {
        var dataKeys = Object.keys(data);
        var param = dataKeys[0] + "=" + data[dataKeys[0]];

        for (var i = 1; i < dataKeys.length; i++) {
          param += this.paramSeparator + dataKeys[i] + "=" + data[dataKeys[i]];
        }

        // Replace , with +
        return param.replace(/,/g, "+");
      },

      htmlSubmit: function (action, data, method) {
        method = method.toUpperCase() || "GET";

        if (method == "GET") {
          // Cleaner version for GET
          window.location.href = action + this.querySeparator + this._generateParams(data);;
        } else {
          // Other methods require a real html form
          var form = document.createElement("form");
          form.setAttribute("method", method);
          form.setAttribute("action", action);

          for (var key in data) {
            if (data.hasOwnProperty(key)) {
              var hiddenField = document.createElement("input");
              hiddenField.setAttribute("type", "hidden");
              hiddenField.setAttribute("name", key);
              hiddenField.setAttribute("value", data[key]);
              form.appendChild(hiddenField);
            }
          }

          document.body.appendChild(form);
          form.submit();
        }
      },

      xhrSubmit: function (url, method, payload, contentType) {
        var el = this;
        vcomet.ajax(url, {
          method: method,
          payload: payload,
          contentType: contentType
        }, function (success, data) {
          vcomet.triggerCallback("onSubmit", el, null, [success, data]);
        });
      },

      handleCheckbox: function (data, node) {
        var checkboxProperty = data[node.name];
        if (node.checked) {
          if (checkboxProperty) {
            if (Object.prototype.toString.call(checkboxProperty) === "[object Array]") {
              checkboxProperty.push(node.value);
            } else {
              data[node.name] = [data[node.name], node.value];
            }

          } else {
            data[node.name] = node.value;
          }
        }
      }

    },

    functions: {
      /*
        @function {Object} getData 
        @description Return form values as an object
      */
      getData: function () {
        var el = this;
        var data = {};

        // Walk form recursively
        el._walkRecursive(el, el, function (node) {

          // Only add elements if they have name, value and not disabled
          if (node.name !== "" && node.value && !node.disabled) {
            // vComet elements
            if (node._formElement) {
              if (node.nodeName.toLowerCase() == "vc-checkbox" || node.nodeName.toLowerCase() == "vc-toggle") {
                el._handleCheckbox(data, node);
              } else {
                data[node.name] = node.value;
              }
            }

            // HTML form elements
            else if (node instanceof HTMLInputElement) {

              // Handle radio
              if (node.type.toLowerCase() == "radio") {
                if (node.checked) {
                  data[node.name] = node.value;
                }
              }

              // Handle checkbox
              else if (node.type.toLowerCase() == "checkbox") {
                el._handleCheckbox(data, node);
              }

              // Handle all other HTMLInputElement
              else {
                data[node.name] = node.value;
              }
            }

            // Other HTML form elements
            else if (node instanceof HTMLTextAreaElement
              || node instanceof HTMLOptionElement
              || node instanceof HTMLSelectElement
              || node instanceof HTMLDataListElement) {
              data[node.name] = node.value;
            }
          }


        });

        return data;
      },

      /*
        @function submit
        @description Sent the form data
      */
      submit: function () {
        var el = this;
        var type = el.type.toLowerCase();
        var url = el.url ? el.url : el.action;
        var method = el.method.toUpperCase();
        var data = el.getData();

        if (type == "html") { // Mimics html form including redirect
          el._htmlSubmit(url, data, method);
        } else if (type == "query") { // Uses query string with the given method
          el._xhrSubmit(url + el.querySeparator + el._generateParams(data), method);
        } else if (type == "form-data") { // Uses query string with GET and FormData with all others.
          if (method == "GET") {
            // Since GET can't have a body send a query string instead
            el._xhrSubmit(url + el.querySeparator + el._generateParams(data), method);
          } else {
            var formData = new FormData();
            for (var key in data) {
              formData.append(key, data[key]);
            }
            el._xhrSubmit(url, method, formData, "application/x-www-form-urlencoded");
          }
        } else if (type == "json") { // Uses a JSON payload and the given method
          el._xhrSubmit(url, method, JSON.stringify(data), "application/json");
        }
      }
    },

    onCreated: function () {
      vcomet.createCallback("onSubmit", this);
    },


    onRender: function () {
      var el = this;
      var submit = el.querySelector('[type="submit"]');

      if (submit) {
        submit.addEventListener("click", function () {
          el.submit();
        }, true);
      }
    }

  });

</script>