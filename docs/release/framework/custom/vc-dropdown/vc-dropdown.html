<template>

  <div class="vc-dropdown-main">
    <div class="vc-dropdown-button unselectable">
      <input type="text" readonly>
      <i class="material-icons vc-dropdown-icon">expand_more</i>
    </div>
    <span class="vc-dropdown-underline"></span>
  </div>

  <div class="vc-dropdown-dropdown hidden"></div>

</template>

<script type="text/javascript">
  vcomet.element("vc-dropdown", "", {

    themed: true,

    privateProperties: {
      /*
      @property (private) {string} _formelement 
      @description Necessary property for a form
      */
      formelement: {
        value: "dropdown"
      },
      /*
      @property {object} _refs
      @description Object with references to relevant element nodes
      */
      refs: {
        value: {},
        reflect: false
      },
    },

    properties: {
      /*
      @property {string} name
      @description Name of the dropdown
      */
      name: {
        value: "combobox",
        reflect: true
      },
      /*
      @property {string} name
      @description Name of the dropdown
      */
      placeholder: {
        value: "Placeholder",
        reflect: true
      },
    },
    functions: {
      /*
      @function setupQuickAccess
      @description Assigns some quick access to some node to avoid using same querySelectors all the time
      */
      setupQuickAccess: function () {

        var el = this;

        el._refs.input = el.template.querySelector("input");
        el._refs.dropDown = el.template.querySelector(".vc-dropdown-dropdown");
        el._refs.dropDownButton = el.template.querySelector(".vc-dropdown-button");
        el._refs.underline = el.template.querySelector(".vc-dropdown-underline");

      },
      /*
      @function _setupScroll
      @description Assigns some quick access to some node to avoid using same querySelectors all the time
      */
      setupScroll: function () {

        var el = this;

        el._refs.scroll = document.createElement("vc-scroll");
        el._refs.scroll.thickness = 8;

        el._refs.dropDown.appendChild(el._refs.scroll);

      },
      /*
      @function setupFocusTriggers
      @description Sets up the combobox to be expanded on focus
      */
      setupTriggers: function () {

        var el = this;

        el._refs.dropDownButton.addEventListener("click", function () {
          el.toggleDropdown();
        });

        document.body.addEventListener("click", function (e) {
          el.customBlur(e);
        });

      },
      /*
      @function setupItems
      @description /Sets up the declarative user options for the dropdown
      */
      setupItems: function () {

        var el = this;

        var sourceNodes = el.getSourceElements();

        var itemsDocFragment = document.createDocumentFragment();
        var length = sourceNodes.length;
        var item;

        for (var i = 0; i < length; i++) {

          item = sourceNodes[i];

          el.setupItem(item);

          itemsDocFragment.appendChild(item);
        }

        el._refs.scroll.content.appendChild(itemsDocFragment);

      },
      setupItem: function (item) {

        var el = this;

        item.onRender(function () {

          var span = document.createElement("span");

          this.classList.add("vc-dropdown-result");
          this.value = this.getAttribute("value");
          this.displayValue = this.getAttribute("display-value") || this.value;

          span.innerHTML = this.displayValue;

          this.appendChild(span);
          this.addEventListener("click", function () { el.select(this) });

          el.setupIcon(this);

        });

      },
      /*
      @function setupIcon
      @description Creates the icon for the given item
      @param {object} item
      */
      setupIcon: function (item) {
        var iconAttribute = item.getAttribute("icon");
        var iconPosition = item.getAttribute("icon-position");
        var icon;

        if (iconAttribute != "") {

          if (iconAttribute.indexOf("</i>") > -1) {
            var tempDiv = document.createElement("div");

            tempDiv.innerHTML = iconAttribute;
            icon = tempDiv.querySelector("i");
            icon.classList.add("vc-dropdown-ItemIcon");

          } else {

            icon = document.createElement("div");
            icon.style.backgroundImage = "url('" + iconAttribute + "')";
            icon.classList.add("vc-dropdown-ItemIcon");
          }

          if (iconPosition == "left") {

            item.insertBefore(icon, item.childNodes[0]);

          } else {

            item.appendChild(icon);
          }

        }

      },
      /*
      @function addItem
      @description Creates the events and adds the classes for the given item
      @param {object} item
      */
      addItem: function (item) {

        var el = this;
        var dropdown = this.querySelector(".vc-dropdown-dropdown");

        el.setupItem(item);

        item.addEventListener("click", function () {
          el.shrink(el)
        });

        dropdown.vcometScroll.content.appendChild(item);
        el._refs.scroll.update();
      },
      /*
      @function select
      @description Selects the given item
      @param {object} item
      */
      select: function (item) {

        var el = this;

        var value = item.getAttribute("value") || item.value;
        var displayValue = item.getAttribute("display-value");

        el.setAttribute("value", value);
        el.value = value;
        el._refs.input.value = displayValue;

        vcomet.triggerCallback("onSelected", el, el, [item]);

        el.shrink();

      },
      /*
      @function customBlur
      @description Handles the blur
      @param {object} e [Event that triggered the blur]
      */
      customBlur: function (e) {

        var el = this;

        if (el.isOnPath == false) {
          el.shrink();
        }
      },
      /*
      @function toggleDropdown
      @description Toggles the dropdown
      */
      toggleDropdown: function () {

        var el = this;

        if (el._refs.dropDown.classList.contains("expanded")) {
          el.shrink();
        } else {
          el.expand();
        }
      },
      /*
      @function expand
      @description Expands the dropdown
      */
      expand: function () {

        var el = this;

        if (!el._refs.dropDown.classList.contains("expanded")) {
          el._refs.dropDown.classList.add("expanded");
          el.classList.add("focus");
          el._refs.scroll.update();
        }
      },
      /*
      @function shrink
      @description Shrinks the dropdown
      */
      shrink: function () {

        var el = this;

        el._refs.dropDown.classList.remove("expanded");
        el.classList.remove("focus");

      },
      /*
      @function (private) _expand
      @description Shows the picker
      */
      expand: function () {

        var el = this;

        el._refs.dropDown.style.top = el.offsetTop + el.offsetHeight + 2 + "px";
        el._refs.dropDown.style.left = el.offsetLeft + "px";
        el._refs.dropDown.style.width = el.offsetWidth + "px";

        document.body.appendChild(el._refs.dropDown);

        el._refs.dropDown.classList.remove("hidden");
        el.classList.add("focus");
        el._refs.scroll.update();

      },
      /*
      @function reset
      @description Cleans everything to set the element as new
      */
      reset: function () {

        var el = this;

        el.value = "";
        el.setAttribute("value", "");
        el._refs.input.value = "";

      }
    },
    onCreated: function () {

      var el = this;

      el.setupQuickAccess();
      el.setupScroll();

      vcomet.createCallback("onSelected", el);

    },
    onRender: function () {

      var el = this;

      vcomet.registerPathListener(el);

      el.setupTriggers();
      el.setupItems();

      el._refs.input.setAttribute("placeholder", el.placeholder);

    }
  });
</script>