<template class="vc-sect1"></template>

<script>
  vcomet.element("vc-menu", "vc-menu.css", {

    dependencies: [
      "../vc-item"
    ],
    privateProperties: {
      refs: {
        value: {},
      },
      misc: {
        value: {},
      }
    },
    properties: {
      spacing: {
        value: 0,
        reflect: true
      }
    },
    privateFunctions: {
      /*
      @function (private) _setup
      @description Sets up everything needed for the component
      */
      setup: function () {

        var el = this;

        el._setupMisc();
        el._setupRefs();

        el._setupDesktopBehavior();
        el._setupDeviceBehavior();

        el._handleWindowSize();

      },
      /*
      @function (private) _setupMisc
      @description Prepares the misc object to hold usefull information
      */
      setupMisc: function () {

        var el = this;

        el._misc.dropdowns = {};
        el._misc.dropdowns.path = [];

        el._misc.modal = {};
        el._misc.modal.pages = {};
        el._misc.main = [];
        el._misc.tree = {};
        el._misc.items = {};

        el._misc.displayDuration = 500;
        el._misc.hideDuration = 300;

      },
      /*
      @function (private) _setupRefs
      @description Prepares the refs object to hold usefull references
      */
      setupRefs: function () {

        var el = this;

        el._refs.dropdowns = {};

        el._refs.device = {};
        el._refs.device.path = [];
        el._refs.device.items = {};

      },
      /*
      @function (private) _setupDesktopBehavior
      @description Prepares everything needed for the desktop behavior
      */
      setupDesktopBehavior: function () {

        var el = this;

        // Creats the vc-items wrapper
        el._refs.wrapper = document.createElement("div");
        el._refs.wrapper.classList.add("vc-menu-wrapper", "vc-fg1", "vc-unselectable");
        el._refs.wrapper.appendChild(el.template);

        // Loops through the first level of vc-items and saves them as the main items
        for (var i = 0; i < el._refs.wrapper.children.length; i++) {
          el._setupItem(el._refs.wrapper.children[i]);
          el._misc.main.push([el._refs.wrapper.children[i].getAttribute("name")]);
        }

        el.appendChild(el._refs.wrapper);

      },
      /*
      @function (private) _setupDeviceBehavior
      @description Prepares everything needed for the device behavior
      */
      setupDeviceBehavior: function () {

        var el = this;
        var item;

        el._setupModalView();
        el._setupModalViewTrigger();

        // Creates the main page
        el._misc.modal.pages["main"] = document.createElement("div");
        el._misc.modal.pages["main"].classList.add("vc-menu-page", "vc-sect1");
        el._misc.modal.pages["main"].dataset.main = "true";

        // Loops through the main items and appends them to the main page, then checks if they have 
        // vc-item childs to create more pages, and loops through those childs to see if more pages are needed
        for (var i = 0; i < el._misc.main.length; i++) {

          item = el._setupModalItem(el._misc.main[i]);

          if (el._misc.tree[item.name].length > 0) {
            el._setupModalPage(item);
          }

          el._misc.modal.pages["main"].appendChild(item);

        }

        el._refs.modalBody.appendChild(el._misc.modal.pages["main"]);

      },
      /*
      @function (private) _setupModalView
      @description Prepares the node in which the user will experience the modal behavior
      */
      setupModalView: function () {

        var el = this;

        el._refs.modal = document.createElement("div");
        el._refs.modalHead = document.createElement("div");
        el._refs.modalBody = document.createElement("div");

        el._refs.backButton = document.createElement("div");
        el._refs.path = document.createElement("div");
        el._refs.pathSpan = document.createElement("span");
        el._refs.closeButton = document.createElement("div");

        el._refs.modal.classList.add("vc-menu-modal", "vc-sect1", "vc-fg1");
        el._refs.modalHead.classList.add("vc-menu-head");
        el._refs.modalBody.classList.add("vc-menu-body");

        el._refs.closeButton.classList.add("vc-menu-button", "vicon", "vicon-close");
        el._refs.path.classList.add("vc-menu-path");
        el._refs.backButton.classList.add("vc-menu-button", "vc-menu-hidden", "vicon", "vicon-arrow-back");

        el._refs.backButton.addEventListener("click", function () {
          el._previousPage();
        });

        el._refs.closeButton.addEventListener("click", function () {
          el.hideModalView();
        });

        el._refs.path.appendChild(el._refs.pathSpan);

        el._refs.modalHead.appendChild(el._refs.backButton);
        el._refs.modalHead.appendChild(el._refs.path);
        el._refs.modalHead.appendChild(el._refs.closeButton);

        el._refs.modal.appendChild(el._refs.modalHead);
        el._refs.modal.appendChild(el._refs.modalBody);

      },
      /*
      @function (private) _setupModalViewTrigger
      @description Prepares the button that will trigger the modal node to appear
      */
      setupModalViewTrigger: function () {

        var el = this;
        var icon = document.createElement("i");

        icon.classList.add("vicon", "vicon-menu");

        el._refs.device.button = document.createElement("div");
        el._refs.device.button.classList.add("vc-menu-modalButton", "vc-fg1");
        el._refs.device.button.appendChild(icon);

        el._refs.device.button.addEventListener("click", function () {
          el.displayModalView();
        });

        el.appendChild(el._refs.device.button);

      },
      /*
      @function (private) _setupModalItem
      @description Takes the cloned declarative items and moves them to the modal view
      @param {String} name 
      */
      setupModalItem: function (name) {

        var el = this;

        var item = el._refs.device.items[name];
        var link = document.createElement("a");
        var span = document.createElement("span");

        span.innerHTML = item.getAttribute("name");

        link.appendChild(span);

        if (item.hasAttribute("href")) {
          link.setAttribute("href", item.getAttribute("href"));
        }

        if (!(el._misc.tree[name].length > 0)) {
          item.addEventListener("click", function () {
            el.hideModalView();
          });
        }

        item.appendChild(link);

        return item;

      },
      /*
      @function (private) _setupItem
      @description Creates a page for the child items
      @param {Object} item 
      */
      setupItem: function (item) {

        var el = this;
        var link, span;

        el._misc.tree[item.getAttribute("name")] = [];
        el._refs.device.items[item.getAttribute("name")] = item.cloneNode(false);

        el._setupDropdown(item);
        el._setupEvents(item);

        link = document.createElement("a");
        span = document.createElement("span");
        span.innerHTML = item.getAttribute("name");

        link.appendChild(span);

        if (item.hasAttribute("href")) {
          link.setAttribute("href", item.getAttribute("href"));
        }

        item.appendChild(link);

        item.classList.add("vc-sect3-hoverable");

      },
      /*
      @function (private) _setupDropdown
      @description Creates a dropdown for the child items
      @param {Object} item 
      */
      setupDropdown: function (item) {

        var el = this;

        if (item.children.length > 0) {

          var dropdown = document.createElement("div");
          var wrapper = document.createElement("div");
          var child;

          dropdown.classList.add("vc-menu-dropdown", "vc-fg1");
          wrapper.classList.add("vc-menu-wrapper", "vc-sect1");

          while (item.children.length > 0) {

            child = item.children[0];

            if (child.nodeName.toLowerCase() == "vc-item") {
              el._setupItem(child);
              el._misc.tree[item.getAttribute("name")].push(child.getAttribute("name"));
            }

            wrapper.appendChild(child);

          }

          el._refs.dropdowns[item.getAttribute("name")] = dropdown;

          dropdown.appendChild(wrapper);

        }

      },
      /*
      @function _setupEvents
      @description Sets up the events for the menu item
      @param {Object} item
      */
      setupEvents: function (item) {

        var el = this;

        // Dropdown item visited
        item.addEventListener("pointerenter", function (e) {
          // Check if menu dropdown is already displayed
          if (!item.classList.contains("vc-sect3")) {
            // Highlights the item
            item.classList.add("vc-sect3");
            el._showDropdown(item);
          }
        });

        // Dropdown item left
        item.addEventListener("pointerleave", function (e) {
          // Check if menu dropdown is already hidden
          if (item.classList.contains("vc-sect3")) {
            // Removes the item highlight
            item.classList.remove("vc-sect3");
            el._hideDropdown(item);
          }

        });

      },
      /*
      @function (private) _setupModalPage
      @description Creates a page for the child items
      @param {Object} item 
      */
      setupModalPage: function (item) {

        var el = this;

        var items = el._misc.tree[item.name];
        var child;

        el._misc.modal.pages[item.name] = document.createElement("div");
        el._misc.modal.pages[item.name].classList.add("vc-menu-page", "vc-sect1");

        for (var i = 0; i < items.length; i++) {

          child = el._setupModalItem(items[i]);

          if (el._misc.tree[child.name].length > 0) {
            el._setupModalPage(child);
          }

          el._misc.modal.pages[item.name].appendChild(child);

        }

        item.addEventListener("click", function () {

          el._refs.modalBody.appendChild(el._misc.modal.pages[item.name]);

          el._displayPage(el._misc.modal.pages[item.name], true);

          el._refs.device.path.push(item.name);
          el._refs.pathSpan.innerHTML = item.name;
          el._refs.backButton.classList.remove("vc-menu-hidden");

        });

        el._refs.modalBody.appendChild(el._misc.modal.pages[item.name]);

      },
      /*
      @function (private) _displayPage
      @description Displays the provided page with/without animate
      @param {Object} page
      @param {Boolean} animate
      */
      displayPage: function (page, animate) {

        var el = this;

        if (animate) {

          var endTime = + new Date() + el._misc.displayDuration;

          var frameFunction = function () {

            var runTime = + new Date();
            var progress = (endTime - runTime) / el._misc.displayDuration;

            // Ease progress
            progress = Math.pow(progress, 3) * 100;
            progress = progress < 0 ? 0 : progress;

            page.style.transform = "translate3d(" + progress + "%, 0, 0)";

            if (progress > 0) {
              window.requestAnimationFrame(frameFunction);
            }

          }

          frameFunction();

        } else {

          page.style.transform = "translate3d(0%, 0, 0)";

        }

      },
      /*
      @function (private) _hidePage
      @description Hides the provided page with/without animation
      @param {Object} page
      @param {Boolean} animate
      */
      hidePage: function (page, animate) {

        var el = this;

        if (animate) {

          var endTime = + new Date() + el._misc.hideDuration;

          var frameFunction = function () {

            var runTime = + new Date();
            var progress = (endTime - runTime) / el._misc.hideDuration;

            progress = 1 - progress;

            // Ease progress
            progress = Math.pow(progress, 3) * 100;
            progress = progress > 100 ? 100 : progress;

            page.style.transform = "translate3d(" + progress + "%, 0, 0)";

            if (progress < 100) {
              window.requestAnimationFrame(frameFunction);
            }

          }

          frameFunction();

        } else {

          page.style.transform = "translate3d(100%, 0, 0)";

        }

      },
      /*
      @function _showDropdown
      @description Shows the dropdown for the given item
      @param {Object} item
      */
      showDropdown: function (item) {

        var el = this;

        if (el._refs.dropdowns[item.name]) {
          el._assignDropdownStyle(item);
        }

      },
      /*
      @function _hideDropdown
      @description Hides the dropdown for the given item
      @param {Object} item
      */
      hideDropdown: function (item) {

        var el = this;
        var pathIndex = el._misc.dropdowns.path.indexOf(item.name);

        if (el._refs.dropdowns[item.name]) {

          el._refs.dropdowns[item.name].parentNode.removeChild(el._refs.dropdowns[item.name]);

          for (var i = el._misc.dropdowns.path.length; pathIndex < i; i--) {
            el._misc.dropdowns.path.pop()
          }

        }

      },
      /*
      @function _assignDropdownStyle
      @description Determines and assigns the location of the dropdown
      @param {Object} item
      */
      assignDropdownStyle: function (item) {

        var el = this;
        var dropdown = el._refs.dropdowns[item.name];

        dropdown.style[el._misc.dropdowns.path.length > 0 ? "paddingLeft" : "paddingTop"] = parseInt(el.spacing) + "px";
        dropdown.dataset.position = el._misc.dropdowns.path.length > 0 ? "right" : "bottom";
        dropdown.style.height = (item.offsetHeight * dropdown.querySelectorAll("vc-item").length) + "px";

        item.appendChild(dropdown);

        el._misc.dropdowns.path.push(item.name);

      },
      /*
      @function _previousPage
      @description For the device modal view
      */
      previousPage: function () {

        var el = this;
        var lastPage = el._misc.modal.pages[el._refs.device.path.pop()];

        if (lastPage) {
          el._hidePage(lastPage, true);
        }

        if (el._refs.device.path.length == 0) {
          el._refs.backButton.classList.add("vc-menu-hidden")
        }

        el._refs.pathSpan.innerHTML = el._refs.device.path.length > 0 ? el._refs.device.path[el._refs.device.path.length - 1] : "";

      },
      /*
      @function _handleWindowSize
      @description Toggles between the device and desktop view depending on the window size
      */
      handleWindowSize: function () {
        this.classList[window.innerWidth <= vcomet.tabletWidth ? "add" : "remove"]("vc-menu-device");
      },
      /*
      @function exceesWindow
      @description If the dropdown to be opened exceeds we return an object with data about the sides that have ben exceeded
      @param {Object} element
      */
      exceedsWindow: function (element) {

        var elementRect = element.getBoundingClientRect();
        var returnObject = {};

        returnObject.exceeds = false;
        returnObject.sides = [];

        if (elementRect.left < 0) {
          returnObject.sides.push("left");
          returnObject.exceeds = true;
        }
        if ((elementRect.left + elementRect.width) > window.innerWidth) {
          returnObject.sides.push("right");
          returnObject.exceeds = true;
        }
        if (elementRect.top < 0) {
          returnObject.sides.push("top");
          returnObject.exceeds = true;
        }
        if (elementRect.top + elementRect.height > window.innerHeight) {
          returnObject.sides.push("bottom");
          returnObject.exceeds = true;
        }

        return returnObject;
      }
    },
    functions: {
      /*
      @function displayModalView
      @description Displays the modal view to nagivate through the menu options
      */
      displayModalView: function () {

        var el = this;

        // Empties the path span since we are in the main page
        el._refs.pathSpan.innerHTML = "";

        // Appends the modal view
        document.body.appendChild(el._refs.modal);
        
        // Triggers onModalDisplay callback
        vcomet.triggerCallback("onModalDisplay", el, el, [el._refs.modal]);

        // After being appended we set the opacity in a timeout so that the transition takes place
        setTimeout(function () {
          el._refs.modal.style.opacity = 1;
        }, 0);

      },
      /*
      @function hideModalView
      @description Hides the modal view
      */
      hideModalView: function () {

        var el = this;

        var hideFunction = function () {

          var visiblePages = el._refs.modalBody.querySelectorAll(".vc-menu-page:not(.vc-menu-hidden)");

          document.body.removeChild(el._refs.modal);
          el._refs.modal.removeEventListener("transitionend", hideFunction);

          // Takes all the visible pages and hides them except for the main one
          for (var i = 0; i < visiblePages.length; i++) {
            if (!visiblePages[i].dataset || !visiblePages[i].dataset.main) {
              el._hidePage(visiblePages[i]);
            }
          }

          // Empties the path and hides the back button
          el._refs.device.path = [];
          el._refs.backButton.classList.add("vc-menu-hidden");

        }

        // Only hide the modal view if its not already hidden
        if (el._refs.modal.style.opacity != 0) {
          el._refs.modal.addEventListener("transitionend", hideFunction);
          el._refs.modal.style.opacity = 0;
        }

      }
    },
    onCreated: function () {

      var el = this;

      vcomet.createCallback("onModalDisplay", el);

    },
    onInit: function () {
      this._setup();
    },
    onWindowResize: function () {
      this._handleWindowSize();
      this.hideModalView();
    }
  });
</script>