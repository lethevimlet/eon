<template></template>
<script>
  vcomet.element("vc-form", null, {
    properties: {
      /*
        @property {String} querySeparator 
        @description Set query separator
      */
      querySeparator: {
        value: "?",
        reflect: true
      },
      /*
        @property {String} paramSeparator 
        @description Set param separator
      */
      paramSeparator: {
        value: "&",
        reflect: true
      },
      /*
        @property {String} type 
        @description Set form type
      */
      type: {
        value: "html",
        reflect: true
      },
      /*
        @property {String} url 
        @description Set where to send form data
      */
      url: {
        value: "",
        reflect: true
      },
      /*
        @property {String} action 
        @description Same as url, respecting html standard
      */
      action: {
        value: "",
        reflect: true
      },
      /*
        @property {String} method 
        @description Set how send form data
      */
      method: {
        value: "",
        reflect: true
      }
    },
    privateFunctions: {
      /*
        @function (private) _recursiveFormChilds
        @description Loop through form childs
        @param {Object} data [Will contain input type form data]
        @param {Array} formChilds [Form child node]
        @param {String} childPrototype [html type]
        @param {String} inputType [Will contain form child node input type]
        @param {String} elementName [Will contain form child node name]
        @param {String} elementValue [Will contain form child node value]
        @param {Array} checkElements [Will contain checked nodes of checkbox input type]
        @param {Object} checkboxGroups [Will contain checkbox groups of checkbox input type]
      */
      recursiveFormChilds: function (data, formChilds, childPrototype, inputType, elementName, elementValue, checkElements, checkboxGroups) {
        var el = this;
        var formChildNode;

        for (var i = 0; i < formChilds.length; i++) {

          formChildNode = formChilds[i];
          childPrototype = el._getChildPrototypeType(formChildNode);

          if (childPrototype.indexOf("HTMLInputElement") !== -1
            || childPrototype.indexOf("HTMLTextAreaElement") !== -1
            || childPrototype.indexOf("HTMLSelectElement") !== -1
            || formChildNode._formelement) {

            el._setDataElements(data, formChildNode, childPrototype, inputType, elementName, elementValue, checkElements, checkboxGroups);

          } else if (formChildNode.childNodes.length != 0) {

            el._recursiveFormChilds(data, formChildNode.childNodes, childPrototype, inputType, elementName, elementValue, checkElements, checkboxGroups);
          }
        }

      },

      /*
        @function (private) {object} _setDataElements
        @description Set to data object form data
        @param {Object} data [Will contain input type form data]
        @param {Object} formChildNode [Form child node]
        @param {String} childPrototype [html type]
        @param {String} inputType [Will contain form child node input type]
        @param {String} elementName [Will contain form child node name]
        @param {String} elementValue [Will contain form child node value]
        @param {Array} checkElements [Will contain checked nodes of checkbox input type]
        @param {Object} checkboxGroups [Will contain checkbox groups of checkbox input type]
      */
      setDataElements: function (data, formChildNode, childPrototype, inputType, elementName, elementValue, checkElements, checkboxGroups) {
        var el = this;

        // Input elements
        if (childPrototype.indexOf("HTMLInputElement") !== -1 || formChildNode._formelement) {
          el._setInputData(formChildNode, inputType, elementName, elementValue, checkboxGroups, checkElements, data);
        }

        // HTML text area elements
        if (childPrototype.indexOf("HTMLTextAreaElement") !== -1) {

          elementName = formChildNode.name;
          elementValue = formChildNode.value;

          // Adding name and value of element at the submit object
          data[elementName] = elementValue;

        }

        // HTML select elements
        if (childPrototype.indexOf("HTMLSelectElement") !== -1) {
          elementName = formChildNode.name;
          elementValue = formChildNode.value;

          // Adding name and value of element at the submit object
          data[elementName] = elementValue;
        }

      },

      /*
        @function (private) {String} _getChildPrototypeType
        @description Return html type
        @param {Object} formChildNode [Form child node]
      */
      getChildPrototypeType: function (formChildNode) {
        // This method doesn't work at Firefox and Edge
        // childPrototype = Object.getPrototypeOf(formChildNode).toString();
        // Case html form elements on Firefox and Edge (??? Safari and IE)
        // And html form elements and vcomet form elements on Chrome and Opera
        if (formChildNode.__proto__.toString().indexOf("HTMLInputElement") !== -1
          || formChildNode.__proto__.toString().indexOf("HTMLSelectElement") !== -1
          || formChildNode.__proto__.toString().indexOf("HTMLTextAreaElement") !== -1
        ) {
          return formChildNode.__proto__.toString();
          // Case vcomet form element on Firefox and Edge
        } else if (formChildNode.__proto__.__proto__.toString().indexOf("HTMLInputElement") !== -1) {
          return formChildNode.__proto__.__proto__.toString();
        } else {
          return "not input";
        }
      },

      /*
        @function (private) _setInputData
        @description Set to data object input type form data
        @param {Object} formChildNode [Form child node]
        @param {String} inputType [Will contain form child node input type]
        @param {String} elementName [Will contain form child node name]
        @param {String} elementValue [Will contain form child node value]
        @param {Object} checkboxGroups [Will contain checkbox groups of checkbox input type]
        @param {Array} checkElements [Will contain checked nodes of checkbox input type]
        @param {Object} data [Will contain input type form data]
      */
      setInputData: function (formChildNode, inputType, elementName, elementValue, checkboxGroups, checkElements, data) {
        inputType = formChildNode.getAttribute("type");
        elementName = formChildNode.name;

        // Checkbox elements
        if (inputType == "checkbox" || formChildNode._formelement == "checkbox") {

          if (vcomet.util.isTrue(formChildNode.checked) && !vcomet.util.isTrue(formChildNode.disabled)) {
            // console.log('formChildNode', formChildNode);
            elementValue = formChildNode.value;

            // If the checkbox group has not been stored yet
            // initialize the array that will store the values associated with that checkbox group
            if (!checkboxGroups[elementName]) {

              checkElements = [];
              checkElements.push(elementValue);
              checkboxGroups[elementName] = checkElements;

              // Store the value in the corresponding checkbox group
            } else {
              checkboxGroups[elementName].push(elementValue);
            }

            // Adding name of checkbox group and the checked values at the submit object
            data[elementName] = checkboxGroups[elementName];

          }

          // Radio button elements
        } else if (inputType == "radio" || formChildNode._formelement == "radio") {

          if (vcomet.util.isTrue(formChildNode._checked) && !vcomet.util.isTrue(formChildNode._disabled)) {

            elementValue = formChildNode.value;
            // Adding name and value of element at the submit object
            data[elementName] = elementValue;

          }

          // Slider elements
        } else if (inputType == "range" || formChildNode._formelement == "slider") {

          if (!vcomet.util.isTrue(formChildNode.disabled)) {
            elementName = formChildNode.name;
            elementValue = formChildNode.value;
            // Adding name and value of element at the submit object
            data[elementName] = elementValue;
          }

          // vComet textbox, textarea and others html elements
        } else {
          elementValue = formChildNode.value;
          if (!vcomet.util.isTrue(formChildNode.disabled)) {
            // Control if the input has no value
            if (elementValue !== "" && typeof elementValue != "undefined") {
              // Adding name and value of element at the submit object
              data[elementName] = elementValue;
            }
          }
        }
      },

      /*
        @function (private) {String} _generateParams
        @description Return an string of form data for ajax request
        @param {Object} data [Form data]
      */
      generateParams: function (data) {
        var param = "";
        var dataKeys = Object.keys(data);
        var i;

        for (i = 0; i < dataKeys.length; i++) {
          param += dataKeys[i] + "=" + data[dataKeys[i]];

          if (i < dataKeys.length - 1) {
            param += this.paramSeparator;
          }
        }

        return param.replace(/,/g, "+");
      },

      htmlSubmit: function (action, data, method) {
        method = method.toUpperCase() || "GET";

        if (method == "GET") {
          // Cleaner version for GET
          window.location.href = action + this.querySeparator + this._generateParams(data);;
        } else {
          // Other methods require a real html form
          var form = document.createElement("form");
          form.setAttribute("method", method);
          form.setAttribute("action", action);

          for (var key in data) {
            if (data.hasOwnProperty(key)) {
              var hiddenField = document.createElement("input");
              hiddenField.setAttribute("type", "hidden");
              hiddenField.setAttribute("name", key);
              hiddenField.setAttribute("value", data[key]);
              form.appendChild(hiddenField);
            }
          }

          document.body.appendChild(form);
          form.submit();
        }
      },

      xhrSubmit: function (url, method, payload, contentType) {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
          if (this.readyState == 4) {
            var error = this.status < 200 && this.status >= 300;

            vcomet.triggerCallback("onSubmit", el, null, [error, {
              url: url,
              method: method,
              status: this.status,
              response: this.response
            }]);
          };
        };

        xhr.open(method, url);
        if (contentType) {
          xhr.setRequestHeader("Content-Type", contentType);
        }
        if (payload) {
          xhr.send(payload);
        } else {
          xhr.send();
        }
      }

    },

    functions: {
      /*
       @function {Object} getData 
       @description Return form values as an object
     */
      getData: function () {
        var el = this;
        var formChilds = el.childNodes;
        var data = {};
        var checkElements = [];
        var checkboxGroups = {};
        var childPrototype = "not input";
        var inputType;
        var elementName;
        var elementValue;

        el._recursiveFormChilds(data, formChilds, childPrototype, inputType, elementName, elementValue, checkElements, checkboxGroups);

        // User custom elements
        if (el.querySelectorAll("[isform]").length !== 0) {
          var isform = el.querySelectorAll("[isform]");

          for (var i = 0; i < isform.length; i++) {
            elementName = isform[i].getAttribute("name");
            elementValue = isform[i].getAttribute("value");
            // Adding name and value of element at the submit object
            data[elementName] = elementValue;
          }
        }

        return data;
      },
      /*
        @function submit
        @description Sent the form data
      */
      submit: function () {
        var el = this;
        var type = el.type.toLowerCase();
        var url = el.url ? el.url : el.action;
        var method = el.method.toUpperCase();
        var data = el.getData();

        if (type == "html") { // Mimics html form including redirect
          el._htmlSubmit(url, data, method);
        } else if (type == "query") { // Uses query string with the given method
          el._xhrSubmit(url + el.querySeparator + el._generateParams(data), method);
        } else if (type == "form-data") { // Uses query string with GET and FormData with all others.
          if(method == "GET") {
            // Since GET can't have a body send a query string instead
            el._xhrSubmit(url + el.querySeparator + el._generateParams(data), method);
          }else {
            var formData = new FormData();
            for (var key in data) {
              formData.append(key, data[key]);
            }
            el._xhrSubmit(url, method, formData, "application/x-www-form-urlencoded");
          }
        } else if (type == "json") { // Uses a JSON payload and the given method
          el._xhrSubmit(url, method, JSON.stringify(data), "application/json");
        }
      }
    },

    onCreated: function () {
      vcomet.createCallback("onSubmit", this);
    },


    onRender: function () {
      var el = this;
      var submit = el.querySelector('[type="submit"]');

      if (submit) {
        submit.addEventListener("click", function () {
          el.submit();
        }, true);

      }
    },

  });

</script>