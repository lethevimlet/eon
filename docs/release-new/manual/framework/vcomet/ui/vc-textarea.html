<template>

  <div class="textareaGroup unselectable">
    <label class="textareaLabel"></label>

    <div class="textareaWrapper">
      <vc-scroll arrowScrolls="true">
        <div class="textarea" contenteditable="true">
        </div>
      </vc-scroll>
    </div>



    <span class="inputBar"></span>
  </div>

</template>

<script>
  vcomet.element("vc-textarea", {

    themed: true,

    properties: {
      /*
        @property {string} name 
        @description Textarea name
      */
      name: {
        value: "",
        reflect: true
      },
      /*
        @property {string} value 
        @description Textarea value
      */
      value: {
        value: "",
        reflect: true
      },
      /*
        @property {string} placeholder 
        @description Textarea placeholder
      */
      placeholder: {
        value: "",
        reflect: true
      },
      /*
        @property {string} label 
        @description Textarea label
      */
      label: {
        value: "",
        reflect: true
      },
      /*
        @property {string} width 
        @description Textarea size respect to container
        Value must be number percentage
        Default: 50%
      */
      width: {
        value: "50%",
        reflect: true
      },
      /*
        @property {string} rows 
        @description Textarea number rows
        Value must be number percentage
        Default: 50%
      */
      rows: {
        value: "5",
        reflect: true
      },
      /*
        @property {string} disable 
        @description Textarea desactivation
        Values can be: true or false
        Default: false
      */
      disable: {
        value: "false",
        reflect: true
      },
      /*
        @property {string} readonly 
        @description Textarea read only mode
        Values can be: true or false
        Default: false
      */
      readonly: {
        value: "false",
        reflect: true
      },
      /*
        @property {string} maxlength 
        @description Textarea maximum characters number
        Value must be int number
        Default: valueless
      */
      maxlength: {
        value: "",
        reflect: true
      },
      /*
        @property {string} counter 
        @description Textarea characters counter
        Values can be: simple, maximal or false
        Default: false
      */
      counter: {
        value: "false",
        reflect: true
      },
      /*
        @property {string} autofocus 
        @description Textarea automatically get focus when page loads
        Values can be: true or false
        Default: false
      */
      autofocus: {
        value: "false",
        reflect: true
      },
      /*
        @property {string} autoresize 
        @description Textarea increas heigth with text
        Values can be: true or false
        Default: false
      */
      autoresize: {
        value: "false",
        reflect: true
      },
      /*
        @property {string} maxheight 
        @description Textarea maximum height
        Values can be: true or false
        Default: false
      */
      maxheight: {
        value: "false",
        reflect: true
      }
    },

    privateProperties: {
      /*
        @property {string} _formelement 
        @description Set that textarea is a form element
        Value: textarea
      */
      formelement: {
        value: "textarea"
      },
      /*
        @property {string} _currentvalue
        @description Current textarea value
     */
      currentvalue: {
        value: ""
      }
    },

    functions: {
      /*
        @function setValue
        @description Set new textarea value
        @param {string} newVal [new chechbox value]
      */
      setValue: function (newVal) {
        var textarea = this.querySelector(".textarea");

        this.value = newVal;
        textarea.innerHTML = newVal;
        this._currentvalue = newVal;
        vcomet.triggerCallback("onChange", this);
      }
    },

    privateFunctions: {
      /*
        @function (private) _updateDisable
        @description Update disable status
        @param {string} newVal [new value of disabled]
      */
      updateDisable: function (newValue) {
        var textareaGroup = this.querySelector(".textareaGroup");
        var textarea = this.querySelector(".textarea");

        if (newValue == false || newValue == "false") {
          textarea.removeAttribute("disabled");
          textareaGroup.classList.remove("disableTextareaGroup");

        } else {
          textarea.setAttribute("disabled", "true");
          textareaGroup.classList.remove("readonlyTextareaGroup");
          textareaGroup.classList.add("disableTextareaGroup");
        }
      },

      /*
        @function (private) _updateReadonly
        @description Update readonly status
        @param {string} newVal [new value of readonly]
      */
      updateReadonly: function (newValue) {
        var textareaGroup = this.querySelector(".textareaGroup");
        var textarea = this.querySelector(".textarea");
        if (newValue == false || newValue == "false") {
          textarea.removeAttribute("readonly");
          textareaGroup.classList.remove("readonlyTextareaGroup");

        } else {
          textarea.setAttribute("disabled", "true");
          textareaGroup.classList.remove("disableTextareaGroup");
          textareaGroup.classList.add("readonlyTextareaGroup");
        }
      },

      /*
        @function (private) _autoresizeTextarea
        @description Increase textarea height with text
        @param {string} maxheight [maximum textarea height]
      */
      autoresizeTextarea: function (maxheight) {
        var textarea = this.querySelector(".textarea");
        // textarea.style.height = "";

        // Textarea heigth can grow without limits
        // or with a limit set by the user
        // if (maxheight == null) {
        // textarea.style.height = Math.min(textarea.scrollHeight) + "px";
        // } else {
        textarea.style.height = Math.min(textarea.scrollHeight, maxheight) + "px";
        this.querySelector(".textareaWrapper").vcometScroll.update();
        // }
      },

      /*
        @function (private) _addTextCounter
        @description Add text characters counter
        @param {object} textareaGroup [textarea group node]
      */
      addTextCounter: function (textareaGroup) {
        var el = this;
        var counter = document.createElement("div");
        counter.classList.add("counter");
        textareaGroup.parentNode.insertBefore(counter, textareaGroup.nextSibling);

        // Sets inital value of counter
        if (el.counter == "simple") {
          counter.innerHTML = "0";
        } else if (el.counter == "maximal") {

          if (el.maxlength) {
            var maxLength = el.maxlength;
          } else {
            var maxLength = 10;
          }

          counter.innerHTML = "0/" + maxLength;
        }

        el._addCounterListener(maxLength, counter);

      },

      /*
      @function (private) _addTextCounter
      @description Add counter listener 
      @param {string} maxLength [textarea maximum characters number]
      @param {object} counter [textarea couenter node]
      */
      addCounterListener: function (maxLength, counter) {
        var el = this;
        var textarea = el.querySelector(".textarea");

        // Pressing a key activates the counter functionality
        textarea.addEventListener("keydown", function (e) {
          var lengthText = textarea.value.length;

          // Simple character counter
          if (el.counter == "simple" && !el.maxlength) {

            if (e.keyCode == 8) {

              if (lengthText != 0) {
                counter.innerHTML = lengthText - 1;
              }

            } else {
              counter.innerHTML = lengthText + 1;
            }

            // Simple counter with max length character
          } else if (el.counter == "simple" && el.maxlength) {

            if (lengthText >= maxLength && e.keyCode != 8) {
              e.preventDefault(); // Stops the default action of an element from happening
            } else if (lengthText <= maxLength && e.keyCode == 8) {

              if (lengthText <= maxLength && lengthText != 0) {
                counter.innerHTML = (lengthText - 1);
              }

            } else {
              counter.innerHTML = (lengthText + 1);
            }

            // Counter with a maximum of characters
          } else if (el.counter == "maximal") {

            if (lengthText >= maxLength && e.keyCode != 8) {
              e.preventDefault(); // Stops the default action of an element from happening
            } else if (lengthText <= maxLength && e.keyCode == 8) {

              if (lengthText <= maxLength && lengthText != 0) {
                counter.innerHTML = (lengthText - 1) + "/" + maxLength;
              }

            } else {
              counter.innerHTML = (lengthText + 1) + "/" + maxLength;
            }
          }

        }, false);
      }
    },

    /*
      @function onCreated
      @description Set callback 
    */
    onCreated: function () {
      vcomet.createCallback("onChange", this);
    },

    /*
      @function onRender
      @description set attributes and listeners call to functionality
    */
    onBubbleRender: function () {
      var el = this;
      var textareaGroup = el.querySelector(".textareaGroup");
      var textarea = el.querySelector(".textarea");
      var textareaWrapper = el.querySelector(".textareaWrapper");
      var label = el.querySelector(".textareaLabel");
      var counter = el.querySelector(".counter");

      // When the element get focus
      textarea.addEventListener("focus", function () {
        label.classList.add("focusLabel");
        textarea.classList.add("focusTextarea");

        if (counter) {
          counter.classList.add("focusCounter");
        }

      }, false);

      // When the element loses focus
      textarea.addEventListener("blur", function () {
        label.classList.remove("focusLabel");
        textarea.classList.remove("focusTextarea");
        el.value = textarea.value;

        // Trigger onChange callback
        if (textarea.value !== el._currentvalue) {
          el._currentvalue = textarea.value;
          vcomet.triggerCallback("onChange", el);
        }

        if (counter) {
          counter.classList.remove("focusCounter");
        }

      }, false);

      // Sets the limits of the textarea if has autoresize
      if (el.maxheight == "false") {
        var maxheight = null;
      } else {
        var maxheight = el.maxheight;
      }

      // Enables the textarea heigth increase with the content
      // if (el.autoresize == true || el.autoresize == "true") {
      //   textarea.addEventListener("input", function () {
      //     console.log(textarea.value);

      //     el._autoresizeTextarea(maxheight);
      //   }, false);

      // }

      // Sets a default value set by the user
      if (el.value) {
        textarea.innerHTML = el.value;
      }

      // Sets a default placeholder set by the user
      if (el.placeholder) {
        textarea.setAttribute("placeholder", el.placeholder);
      }

      // Sets the label of the input
      if (el.label) {
        label.classList.add("displayLabel");
      }

      // Sets the width of the element
      el.style.width = el.width;

      // Sets the height of the textarea
      if (el.rows == null) {
        textarea.setAttribute("rows", "3");
      } else {
        textarea.setAttribute("rows", el.rows);
      }

      // Sets a max length set by the user
      if (el.maxlength) {
        textarea.setAttribute("maxlength", el.maxlength);
      }

      // Add to the textbox a character counter
      if (el.counter != "false") {
        el._addTextCounter(textareaGroup);
      }

      // Gives autofocus to the textarea
      if (el.autofocus == true || el.autofocus == "true") {
        textarea.setAttribute("autofocus", "true");
      }

      el._updateDisable(el.disable);
      el._updateReadonly(el.readonly);
      el.querySelector(".textareaLabel").innerHTML = el.label;

      // TEST
      // console.log('textareaGroup.vcometScroll.content', textareaWrapper.vcometScroll.content, el.maxheight);

      textareaWrapper.vcometScroll.content.style.maxHeight = el.maxheight + "px";

    },

    /*
      @function onPropertyChanged
      @description Call functionality when change property value 
    */
    onPropertyChanged: function (attrName, oldVal, newVal) {

      switch (attrName) {
        case "disable":
          this._updateDisable(newVal);
          break;
        case "readonly":
          this._updateReadonly(newVal);
          break;
        case "label":
          this.querySelector(".textareaLabel").innerHTML = newVal;
          break;
      }
    }

  });

</script>