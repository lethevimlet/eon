<script type="text/javascript">
  vcomet.element("vc-gutter", "vc-gutter.css", {
    properties: {
      /*
        @property {String} type
        @description Gutter direction type
        Values: horizontal, vertical
        Default: horizontal
      */
      type: {
        value: "horizontal",
        reflect: true
      },
      /*
        @property {String} spliiterSize
        @description 
      */
      splitterSize: {
        value: 6,
        reflect: true
      },
      /*
        @property {Boolean} allowDrag
        @description
      */
      allowDrag: {
        value: true,
        reflect: true
      },
       /*
        @property {Boolean} collapsable
        @description Whether or not the gutter can be collapsed
      */
      collapsable: {
        value: false,
        reflect: true
      },
      /*
        @property {Number} min
        @description
      */
      min: {
        value: 50,
        reflect: true
      },
      /*
        @property {Boolean} max
        @description
      */
      max: {
        value: 50,
        reflect: true
      },
      /*
        @property {Boolean} max
        @description
      */
      responsiveLimit: {
        value: 500,
        reflect: true
      }
    },
    privateProperties:{
      /*
        @property (private) {Object} _refs
        @description
      */
      refs: {
        value: {}
      },
      /*
        @property (private) {Object} _misc 
        @description Tree internal used data
      */
      misc: {
        value: {}
      }
    },
    functions: {
      /*  
        @function (private) 
        @description
      */
      resize: function() {
        var el = this;
        var oldGutterSize = parseFloat(el._misc.size);
        var oldSectionSize = el._refs.section[el._misc.sizeOffProp];
        // Store gutter new size
        el._misc.size = parseFloat(el[el._misc.sizeOffProp]);
        if(el._misc.size !== oldGutterSize){
          // Update before collapse values
          el._sectionResize(oldGutterSize, oldSectionSize);
        }
      }
    },
    privateFunctions: {
      /*
        @function (private) setUpGutter
        @description Apply gutter styling and user customizable behaviour
      */
      setUpGutter: function() {
        var el = this;
        // Set gutter type variables
        el._misc.posProp = el.type == "vertical" ? "top" : "left";
        el._misc.sizeOffProp = el.type == "vertical" ? "offsetHeight" : "offsetWidth";
        el._misc.sizeProp = el.type == "vertical" ? "height" : "width";
        el._misc.axisProp = el.type == "vertical" ? "clientY" : "clientX";
        if(el.type == "vertical") {
          el.classList.add("vc-gutter-vertical");
        }
        // Check if it is a nested gutter
        // ** Solves Safari flex child fit parent bug
        if(el.parentNode.tagName == "VC-SECTION"){
          el.style.position = "absolute";
        }
        // ** Force gutter to fit its parent (no style applied yet)
        el.style[el._misc.sizeProp] = "100%";
        el._misc.size = el[el._misc.sizeOffProp];     
        
      },
      /*
        @function (private) setUpSection
        @description Set sections styling
      */
      setUpSection: function() {
        var el = this;
        var sectionSize;
        var children = el.getSourceElements();
        //
        el._refs.section = children[0];
        el._refs.secSection = children[1];
        //
        el._refs.section.classList.add("vc-gutter-section");
        el._refs.secSection.classList.add("vc-gutter-section", "vc-gutter-secondary");
        //
        sectionSize = (el._misc.size / 2) - (el.splitterSize / 2);
        el._refs.section.style[el._misc.sizeProp] = sectionSize + "px";  
        el._misc.gutterResizePercent = 50;  
      },
      /*
        @function (private) createSeparator
        @description Create splitter and configure it
      */
      setUpSeparator: function() {
        var el = this;
        // Create splitter element
        var fragment = document.createDocumentFragment();
        var splitter = document.createElement("div");
        el._refs.splitter = splitter;
        //
        splitter.style[el._misc.sizeProp] = parseInt(el.splitterSize) + "px";  
        splitter.classList.add("vc-gutter-splitter", "vc-bg8");
        //
        el.appendChild(splitter);
        el.insertBefore(el._refs.splitter, el._refs.secSection);
        // Create collapsable icon
        el._setCollapsable();
      },
      /*
        @function (private) setCollapsable
        @description Collapsable functionality
        @param {Object} splitter [Splitter element reference]
      */
      setCollapsable: function() {
        var el = this;
        if(vcomet.util.isTrue(el.collapsable)){
          // Create separator clickable div
          var clickable = document.createElement("div");
          var clickableZone = document.createElement("div");
          clickable.setAttribute("class", "vc-gutter-splitterClickable");
          // TODO - style encapsulation
          clickable.classList.add("vc-bg3","vc-fg5","vc-bg3-hoverable", "vc-fg3-hoverable");
          clickableZone.classList.add("vc-gutter-clickableZone");
          clickable.setAttribute("touch-action", "none");
          // TODO - Mobile miss click > create transparent bigger child as clickable node
          // Create icon
          var icon = document.createElement("i");
          el._refs.collapseIcon = icon;
          // TODO - style encapsulation
          icon.setAttribute("class", "unselectable vc-gutter-splitterCollapseIcon");
          // ** Fix IE bad icon positioning on horizontal gutter
          if(vcomet.util.getBrowser() === "IE" && el.type === "horizontal"){
             icon.style.position = "relative";
             icon.style.right = "4px";
          }
          el._rotateCollapseIcon();
          clickable.appendChild(icon);
          clickable.appendChild(clickableZone);
          el._refs.splitter.appendChild(clickable);
          // Collapsable click functionality
          el._clickCollapsable(clickable, icon);
        }
      },
      /*
        @function (private) clickCollapsable
        @description Separator clickable zone click functionality
        @param {Object} splitter [Splitter element reference]
        @param {Object} secondSection [Gutter secondary section reference]
        @param {Object} clickable [Gutter clickable node reference]
        @param {Object} icon [Gutter clickable node icon reference]
      */
      clickCollapsable: function(clickable, icon) {
        var el = this;
        var closeMargin = 3;
        var initValue, moveValue, mousedown, mousemove, isInitMajor, closeMarginReached;

        // Store before collapse position values
        el._misc.sizeBeforeCollapse = parseFloat(el._refs.section[el._misc.sizeOffProp]);

        // Set on mousedown listener
        clickable.addEventListener("pointerdown", function(e){
          if(e.button == 0){
            initValue = moveValue = e[el._misc.axisProp];
            mousedown = true;
          }
        }, false);
        // Set on mousemove listener
        el._refs.splitter.addEventListener("pointermove", function(e){
          if(mousedown){
            moveValue = e[el._misc.axisProp];
            mousemove = true;
          }
        });
        // Set on mouseup listener
        document.addEventListener("pointerup", function(){
          
          // Check collapse constraints
          if(mousedown && (initValue === moveValue)){
            el._toggleCollapse();
          } else {
            mousemove = false;
          }
          mousedown = false;
        });
      },
      /*
        @function (private) toggleCollapse
        @description 
        @param {Boolean}
      */
      toggleCollapse: function() {
        var el = this;
        if(!el._misc.collapsed){
          // Set collapse animation style
          el._toggleCollapseAnimation();
          // Store new no collapsed values
          el._misc.sizeBeforeCollapse = el._refs.section[el._misc.sizeOffProp];
          // Collapse
          el._refs.section.style[el._misc.sizeProp] = 0;
          // Rotate arrow icon
          el._rotateCollapseIcon(true);
          el._misc.collapsed = true;
          // Stop animation
          el._toggleCollapseAnimation(true);
        } else {
          // Set expand animation style
          el._toggleCollapseAnimation();
          el._refs.section.style[el._misc.sizeProp] = (el._misc.sizeBeforeCollapse) + "px";
          // Rotate arrow icon
          el._rotateCollapseIcon();
          el._misc.collapsed = false;
          // Stop animation
          el._toggleCollapseAnimation(true);
        }
      }, 
      toggleCollapseAnimation: function(stop) {
        var el = this;
        if(stop){
          // Stop animation
          setTimeout(function () {
            el._refs.section.style.transition = "none";
          }, 200);
        }else{
          // Toggle animation
          el._refs.section.style.transition = el._misc.sizeProp + ".2s";
        }
      },
      /*
        @function (private) rotateCollapseIcon
        @description
      */
      rotateCollapseIcon: function(reverse) {
        var el = this;
        var direction, invert;
        if(el.type =="vertical") {
          // Check icon direction
          direction = reverse ? "down" : "up";
          invert = reverse ? "up" : "down"
          el._refs.collapseIcon.classList.add("vicon-chevron-" + direction);
          el._refs.collapseIcon.classList.remove("vicon-chevron-" + invert);
        } else {
          // Check icon direction
          direction = reverse ? "right" : "left";
          invert = reverse ? "left" : "right"
          el._refs.collapseIcon.classList.add("vicon-chevron-" + direction);
          el._refs.collapseIcon.classList.remove("vicon-chevron-" + invert);
        }
      },
      /*
        @function (private) createSeparator
        @description Create splitter and configure it
      */
      drag: function() {
        var el = this;
        if(vcomet.util.isTrue(el.allowDrag)){
          // Draggable variables
          var mousedown = false;
          var moveValue = 0;
          //TODO
          var pixels, propertyMoveValue;
          // Start slide on mouse down event
          el._refs.splitter.addEventListener("pointerdown", function(e){
            // Needed to prevent bad mouseup event
            e.preventDefault();
            // Only trigger mouse down on splitter element
            if(e.button == 0){
              mousedown = true;
              // Get x/y value
              moveValue = e[el._misc.axisProp];
            }
          }, false);
          // Slide element on mouse move
          el.addEventListener("pointermove", function(e){
            if(mousedown){
              // Get y/z translate pixels
              pixels = moveValue - e[el._misc.axisProp];
              // TODO Set gutter no collapsed
              if(el._misc.collapsed && moveValue !== e[el._misc.axisProp]){
                // Rotate arrow icon to its initial position
                el._rotateCollapseIcon();
                el._misc.collapsed = false;
              }
              // Get top/left property value
              propertyMoveValue = parseFloat(el._refs.section[el._misc.sizeOffProp]) - pixels;
              // Check splitter move constraints
              el._checkMoveConstraints(pixels, propertyMoveValue);
              // Update move value
              moveValue = e[el._misc.axisProp];
            }
          });
          // Stop slide on mouse up
          document.addEventListener("pointerup", function(e){
            // Make sure a movement has been fired
            if(mousedown){
              mousedown = false;
            }
          });
        }
      },
      /*
        @function (private) checkMoveConstraints
        @description Check drag limits before start
        @param {Number} pixels [Move distance in pixels]
        @param {Number} value [New splitter position]
      */
      checkMoveConstraints: function(pixels, value){
        var el = this;
        // Under maximum value or above minimum value
        if((pixels > 0 && value >= el.min) || pixels < 0 && value <= (el._misc.size - el.max)){
          // Update section size to change splitter position
          el._refs.section.style[el._misc.sizeProp] = value + "px";
          el._misc.gutterResizePercent = value * 100 / el._misc.size;
        }
      },
       /*
        @function (private) addGutterResizeListener
        @description Resize listener for responsive purposes
      */
      addGutterResizeListener: function() {
        var el = this;
        // Throttle event triggering for better performance
        var throttled = false;
        var delay = 10;
        vcomet.addResizeListener(el, "resize", function(){
          if (!throttled) {
            el.resize();
            // Throttle
            throttled = true;
            // Set a timeout to un-throttle
            setTimeout(function() {
             throttled = false;
            }, delay);
          }
        });
      },
      /*
        @function (private) sectionResize
        @description
      */
      sectionResize: function(oldGutterSize, oldSectionSize) {
        var el = this;
        var sectionSizePercent, newSectionSize;
        //
        if(!el._misc.collapsed){
          // Get section size percentage before resize
          sectionSizePercent = el._misc.gutterResizePercent;
          // Set new section size
          newSectionSize = sectionSizePercent * el._misc.size / 100;
          // ** TODO? Check max value
          el._refs.section.style[el._misc.sizeProp] = newSectionSize + "px";
        } else {
          // Get value set before been collapsed
          sectionSizePercent = el._misc.sizeBeforeCollapse * 100 / oldGutterSize;
          newSectionSize = sectionSizePercent * el._misc.size / 100;
          el._misc.sizeBeforeCollapse = newSectionSize;
        }
      },
      /*
        @function (private) responsiveListener
        @description Adapt gutter to smaller devices
      */
      responsiveListener: function() {
        var el = this;
        el._misc.desktop = (window.innerWidth <= el.responsiveLimit) ? false : true;
        // Set initial splitter size
        if (!el._misc.desktop) {
          el._changeSplitterSize(15);
        }
        // Apply responsive
        el._applyResponsive();
        // Throttle event triggering for better performance
        var throttled = false;
        var delay = 10;
        window.addEventListener("resize", function(){
          if (!throttled) {
            el._applyResponsive();
            // Throttle
            throttled = true;
            // Set a timeout to un-throttle
            setTimeout(function() {
             throttled = false;
            }, delay);
          }
        });
      },
       /*
        @function (private) applyResponsive
        @description Check device resolution and change the splitter size
      */
      applyResponsive: function() {
        var el = this;
        // Increase splitter under desktop resolution
        if(window.innerWidth <= el.responsiveLimit && el._misc.desktop){
          el._misc.desktop = false;
          el._changeSplitterSize(15);
        }
        // Set splitter standard size on desktop resolution
        if(window.innerWidth > el.responsiveLimit && !el._misc.desktop){
          el._misc.desktop = true;
          el._changeSplitterSize(6);
        }
      },
      /*
        @function (private) changeSplitterSize
        @description Change splitter style size property
        @param {Number} value [New splitter size]
      */
      changeSplitterSize: function(value) {
        var el = this;
        el._refs.splitter.style[el._misc.sizeProp]= value + "px";
      }
    },
    onInit: function() {
      var el = this;
      // Pointer events attribute required
      el.setAttribute("touch-action", "none");
      // Set up gutter
      el._setUpGutter();
      // Set up sections
      el._setUpSection();
    },
    onTransformed: function () {
      var el = this;
       // Create splitter
       el._setUpSeparator();
       // Drag functionality
       el._drag();
       // Control splitter position on window resize
       el._addGutterResizeListener();
       // Responsive behavior
       el._responsiveListener();
    },
    onRender: function () {
      var el = this;
       // Make sure correct size calculation when the gutter is a part of another component
       el.resize();
    }

  });
</script>
