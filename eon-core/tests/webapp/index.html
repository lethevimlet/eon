<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Page Title</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="eon/eon.js"></script>

</head>

<body>

  <script>

    // Tests the impots are working properly
    function importsTest(callback) {

      eon.import([
        "eon/ui/eon-component-1",
        "@ui/eon-component-4"
      ]);

      eon.onImportsReady(function () {
        // We know that for this scenario the are only 7 imported components, 2 of them being included as part of eon, 
        // the components that we are importing (eon-component-4, eon-component-1) and its dependencies (eon-component-2, eon-component-3, eon-custom-1)
        console.log('Object.keys(eon.imports.config).length', Object.keys(eon.imports.config).length);
        callback(Object.keys(eon.imports.config).length == 7);
      });

    }

    // Tests that onPropertyChanged is triggered properly
    function propertyChangedTest(callback) {
      
      eon.import("eon/ui/eon-component-1");

      eon.onImportsReady(function () {
        
        var component = document.createElement("eon-component-1");

        component.label = "Label";

        document.body.appendChild(component);

        component.onPropertyChanged(function (property, oldVal, newVal) {
          callback(property == "label");
        });

        component.onReady(function () {
          component.label = "Changed Label";
        });

      })

    }

    // This tests includes the importing component duration
    function performanceTest(callback) {

      var fragment = document.createDocumentFragment();
      var amount = 10000;
      var maxMiliseconds = 2500;
      var element, start;

      eon.import("eon/ui/eon-component-2");

      for (var i = 0; i < amount; i++) {
        element = document.createElement("eon-component-2");
        fragment.appendChild(element);
      }

      start = Date.now();

      document.body.appendChild(fragment);

      eon.onReady(function () {
        callback((Date.now() - start) < maxMiliseconds);
      });

    }

    function dataDiffingInstanceTest(callback) {
      try {
        new eon.dataDiff();
        callback(true);
      } catch (error) {
        callback(false);
      }
    }

    function dataDiffingCommitTest(callback) {
      // Test operations object
      var operations = {create: 0, update: 0, delete: 0};

      var oldData = new Map();
      oldData.set(0, {name: "Sam", age: 40});
      oldData.set(1, {name: "Will", age: 17});
      oldData.set(2, {name: "Sarah", age: 20});
      oldData.set(3, {name: "John", age: 22});
      oldData.set(4, {name: "Kane", age: 12});

      var data = new Map();
      data.set(0, {name: "Sam", age: 40});
      data.set(1, {name: "William", age: 17});
      data.set(2, {name: "Sarah", age: 20});
      data.set(5, {name: "Steve", age: 88});
      
      // Declare diffing operation functions 
      var diffObj = new eon.dataDiff({
        storeStates: 10,
        create: function(data){
          operations.create++;
        },
        update: function(data){
          operations.update++;
        },
        delete: function(data){
          operations.delete++;
        }
      });
      
      diffObj.commit(data, oldData);

      // Check expected operations
      callback(operations.create == 1 
            && operations.update == 1
            && operations.delete == 2);
    }
  </script>

</body>

</html>