<template class="vc-sect1"></template>

<script>
  vcomet.element("vc-menu", "vc-menu.css", {

    dependencies: [
      "../vc-item"
    ],
    privateProperties: {
      refs: {
        value: {},
      },
      misc: {
        value: {},
      }
    },
    properties: {
      /*
      @property {Boolean} hover
      @description 
      */
      hover: {
        value: false,
        reflect: true
      }
    },
    privateFunctions: {
      /*
      @function _setup
      @description Sets up the menu items and its dropdown recursively
      */
      setup: function () {

        var el = this;

        el._refs.dropdowns = {};

        el._refs.device = {};
        el._refs.device.pages = {};
        el._refs.device.path = [];
        el._refs.device.items = {};

        el._misc.dropdowns = {};
        el._misc.dropdowns.path = [];

        el._misc.modal = {};
        el._misc.roots = [];
        el._misc.tree = {};
        el._misc.items = {};

        el._refs.wrapper = document.createElement("div");
        el._refs.wrapper.classList.add("vc-menu-wrapper", "vc-fg1", "vc-unselectable");
        el._refs.wrapper.appendChild(el.template);

        // Append source nodes
        for (var i = 0; i < el._refs.wrapper.children.length; i++) {
          el._setupItem(el._refs.wrapper.children[i]);
          el._misc.roots.push([el._refs.wrapper.children[i].getAttribute("name")]);
        }

        el._setupOverlay();

        el.appendChild(el._refs.wrapper);

        el._setupForDevice();

        console.log('el._misc', el._misc);
        console.log('el._refs', el._refs);

      },
      setupOverlay: function () {

        var el = this;

        el._refs.overlay = document.createElement("div");
        el._refs.overlay.classList.add("vc-menu-overlay");

        el._refs.overlay.addEventListener("wheel", function (e) {
          e.preventDefault();
          e.stopPropagation();
        });

      },
      setupForDevice: function () {

        var el = this;
        var item;

        el._setupDeviceModal();
        el._setupDeviceButton();

        el._refs.device.pages["roots"] = document.createElement("div");
        el._refs.device.pages["roots"].classList.add("vc-menu-page", "vc-sect1");

        for (var i = 0; i < el._misc.roots.length; i++) {

          item = el._setupDeviceItem(el._misc.roots[i]);

          if (el._misc.tree[item.name].length > 0) {
            el._setupDevicePage(item);
          }

          el._refs.device.pages["roots"].appendChild(item);

        }

        el._refs.modalBody.appendChild(el._refs.device.pages["roots"]);

      },
      setupDeviceButton: function () {
        
        var el = this;
        var icon = document.createElement("i");
        
        icon.classList.add("vicon", "vicon-menu");

        el._refs.device.button = document.createElement("div");
        el._refs.device.button.classList.add("vc-menu-modalButton", "vc-fg1");
        el._refs.device.button.appendChild(icon);

        el.appendChild(el._refs.device.button);

      },
      back: function () {

        var el = this;
        var lastPage = el._refs.device.pages[el._refs.device.path.pop()];

        if (lastPage) {
          setTimeout(function () {
            lastPage.classList.add("vc-menu-hidden");
          }, 0);
        }

        if (el._refs.device.path.length == 0) {
          el._refs.backButton.classList.add("vc-menu-hidden")
        }

      },
      setupDeviceModal: function () {

        var el = this;

        el._refs.modal = document.createElement("div");
        el._refs.modalHead = document.createElement("div");
        el._refs.modalBody = document.createElement("div");

        el._refs.backButton = document.createElement("div");
        el._refs.closeButton = document.createElement("div");

        el._refs.modal.classList.add("vc-menu-modal", "vc-sect1", "vc-fg1");
        el._refs.modalHead.classList.add("vc-menu-head");
        el._refs.modalBody.classList.add("vc-menu-body");

        el._refs.closeButton.classList.add("vc-menu-button", "vicon", "vicon-close");
        el._refs.backButton.classList.add("vc-menu-button", "vc-menu-hidden", "vicon", "vicon-arrow-back");

        el._refs.backButton.addEventListener("click", function () {
          el._back();
        });

        el._refs.modalHead.appendChild(el._refs.backButton);
        el._refs.modalHead.appendChild(el._refs.closeButton);

        el._refs.modal.appendChild(el._refs.modalHead);
        el._refs.modal.appendChild(el._refs.modalBody);

        document.body.appendChild(el._refs.modal);

      },
      setupDeviceItem: function (name) {

        var el = this;

        var item = el._refs.device.items[name];
        var span = document.createElement("span");

        item.name = name;
        span.innerHTML = name;

        item.appendChild(span);

        return item;

      },
      setupDevicePage: function (item) {

        var el = this;

        var items = el._misc.tree[item.name];
        var child;

        el._refs.device.pages[item.name] = document.createElement("div");
        el._refs.device.pages[item.name].classList.add("vc-menu-page", "vc-sect1", "vc-menu-hidden");

        for (var i = 0; i < items.length; i++) {

          child = el._setupDeviceItem(items[i]);

          if (el._misc.tree[child.name].length > 0) {
            el._setupDevicePage(child);
          }

          el._refs.device.pages[item.name].appendChild(child);

        }

        item.addEventListener("click", function () {

          el._refs.modalBody.appendChild(el._refs.device.pages[item.name]);

          setTimeout(function () {
            el._refs.device.pages[item.name].classList.remove("vc-menu-hidden");
            el._refs.device.path.push(item.name);

            if (el._refs.device.path.length > 0) {
              el._refs.backButton.classList.remove("vc-menu-hidden")
            }

          }, 0);

        });

        el._refs.modalBody.appendChild(el._refs.device.pages[item.name]);

      },
      setupItem: function (item) {

        var el = this;
        
        el._misc.tree[item.getAttribute("name")] = [];
        el._refs.device.items[item.getAttribute("name")] = item.cloneNode(false);

        el._setupDropdown(item);
        el._setupVisuals(item);
        el._setupEvents(item);

      },
      setupDropdown: function (item) {

        var el = this;

        if (item.children.length > 0) {

          var dropdown = document.createElement("div");
          var wrapper = document.createElement("div");
          var child;

          dropdown.classList.add("vc-menu-dropdown", "vc-fg1");
          wrapper.classList.add("vc-menu-wrapper", "vc-sect1");

          while (item.children.length > 0) {

            child = item.children[0];

            if (child.nodeName.toLowerCase() == "vc-item") {
              el._setupItem(child);
              el._misc.tree[item.getAttribute("name")].push(child.getAttribute("name"));
            }

            wrapper.appendChild(child);

          }

          el._refs.dropdowns[item.getAttribute("name")] = dropdown;

          dropdown.appendChild(wrapper);

        }

      },
      setupVisuals: function (item) {

        var name = item.getAttribute("name");

        if (name != "") {
          var nameNode = document.createElement("span");
          nameNode.innerHTML = name;
          item.appendChild(nameNode);
        }

        item.classList.add("vc-sect3-hoverable");

      },
      /*
      @function setupEvents
      @description Sets up the click events for the menu items
      @param {object} item
      */
      setupEvents: function (item) {

        var el = this;

        vcomet.registerPathListener(item);

        // el._setupClickEvents(item);
        el._setupHoverEvents(item);

      },
      /*
      @function (private) setupHoverEvents
      @description Creates the hover events for the item
      @param {object} item
      */
      setupHoverEvents: function (item) {

        var el = this;

        if (vcomet.util.isTrue(el.hover)) {

          // Dropdown item visited
          item.addEventListener("pointerenter", function (e) {

            // Check if menu dropdown is already displayed
            if (!item.classList.contains("vc-sect3")) {
              el._highlight(item);
              el._showDropdown(item);
            }

          });

          // Dropdown item left
          item.addEventListener("pointerleave", function (e) {

            // Check if menu dropdown is already hidden
            if (item.classList.contains("vc-sect3")) {
              el._removeHighlight(item);
              el._hideDropdown(item);
            }

          });


        }

      },
      /*
      @function (private) setupClickEvents
      @description Creates the click events for the item
      @param {object} item
      */
      setupClickEvents: function (item, dropdownTrigger, dropdown) {

        var el = this;

        // Dropdown item clicked
        document.body.addEventListener("pointerdown", function (e) {

          if (vcomet.util.isTouchScreen() || (!vcomet.util.isTouchScreen() && el.hover != "true")) {

            if (dropdownTrigger.isOnPath) {

              el._toggleDropdown(item);

            } else if (!item.isOnPath) {

              item.style.visibility = "hidden";
              item.dataset.visible = false;
              item.style.visibility = "visible";

              item.classList.remove("vc-sect3");

            }

          }

        });

      },
      highlight: function (item) {
        item.classList.add("vc-sect3");
      },
      removeHighlight: function (item) {
        item.classList.remove("vc-sect3");
      },
      showDropdown: function (item) {

        var el = this;

        if (el._refs.dropdowns[item.name]) {
          el._assignDropdownStyle(item);
        }

      },
      hideDropdown: function (item) {

        var el = this;
        var pathIndex = el._misc.dropdowns.path.indexOf(item.name);

        if (el._refs.dropdowns[item.name]) {

          el._refs.dropdowns[item.name].parentNode.removeChild(el._refs.dropdowns[item.name]);

          for (var i = el._misc.dropdowns.path.length; pathIndex < i; i--) {
            el._misc.dropdowns.path.pop()
          }

        }

      },
      assignDropdownStyle: function (item) {

        var el = this;
        var dropdown = el._refs.dropdowns[item.name];

        dropdown.dataset.position = el._misc.dropdowns.path.length > 0 ? "right" : "bottom";
        dropdown.style.height = (item.offsetHeight * dropdown.querySelectorAll("vc-item").length) + "px";

        item.appendChild(dropdown);

        el._misc.dropdowns.path.push(item.name);

      },
      handleWindowResize: function () {
        
        var el = this;

        if (window.innerWidth <= vcomet.tabletWidth) {
          console.log('device');
        }

      },
      /*
      @function exceesWindow
      @description If the dropdown to be opened exceeds we return an object with data about the sides that have ben exceeded
      @param {object} element
      */
      exceedsWindow: function (element) {

        var elementRect = element.getBoundingClientRect();
        var returnObject = {};

        returnObject.exceeds = false;
        returnObject.sides = [];

        if (elementRect.left < 0) {
          returnObject.sides.push("left");
          returnObject.exceeds = true;
        }
        if ((elementRect.left + elementRect.width) > window.innerWidth) {
          returnObject.sides.push("right");
          returnObject.exceeds = true;
        }
        if (elementRect.top < 0) {
          returnObject.sides.push("top");
          returnObject.exceeds = true;
        }
        if (elementRect.top + elementRect.height > window.innerHeight) {
          returnObject.sides.push("bottom");
          returnObject.exceeds = true;
        }

        return returnObject;
      },
    },
    onInit: function () {

      var el = this;

      el._setup();

    },
    onWindowResize: function () {
      this._handleWindowResize();
    }
  });
</script>