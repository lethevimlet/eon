<style>
</style>
<template>
    <div class="app-playground-menu">
        <div class="app-playground-menu-title"></div>
        <div class="app-playground-menu-tabs app-playground-hidden"></div>
        <div class="app-playground-filler"></div>
        <app-vicon class="app-playground-toggle" vicon="div" vtitle="go to code" background="rgba(0,0,0,0.1)"></app-vicon>
        <app-vicon class="app-playground-fullscreen" vicon="fullscreen" vtitle="fullscreen" background="rgba(0,0,0,0.1)"></app-vicon>
        <div class="app-playground-menu-links"></div>
    </div>
    <div class="app-playground-content">
        <iframe class="app-playground-hidden"></iframe>
        <eon-editor class="app-playground-hidden" lazy-load="true"></eon-editor>
        <eon-loading class="app-playground-loading"></eon-loading>
        <app-fading in="0" out="0.5"></app-fading>
    </div>
</template>

<script>
    eon.element({
        name: "app-playground",
        name: "app-playground",
        style: "app-playground.css",
        dependencies: [
            "../../eon/ui/eon-editor",
            "../../eon/ui/eon-loading",
            "../../eon/ui/eon-button",
            "../app-vicon",
            "../app-fading"
        ],
        properties: {
            html: {
                value: "",
                reflect: false
            },
            js: {
                value: "",
                reflect: false
            },
            css: {
                value: "",
                reflect: false
            },
            vtitle: {
                value: "",
                reflect: true
            },
            readonly: {
                value: "false",
                reflect: true
            },
            selector: {
                value: "",
                reflect: true
            },
            links: {
                value: "",
                reflect: true
            },
            // @html-attribute format (public) [Format code]
            format: {
                value: "false",
                reflect: true
            },
            // @html-attribute scripts (public) [Scripts to import in result header without show them. Strings separated with comas]
            scripts: {
                value: "",
                reflect: false
            },
            // @html-attribute components (public) [Components to import in result header without show them. Note that eon.js should be added to scripts in order to use components import. Strings separated with comas]
            components: {
                value: "",
                reflect: false
            }
        },

        privateProperties: {
            refs: {
                value: {}
            },
            misc: {
                value: {}
            }
        },

        functions: {
            // @function setTitle (public) [Set playground title]
            setTitle: function (title) {
                var el = this;
                el._refs.title.innerHTML = title ? title : el.vtitle;
            },
            // @function setLinks (public) [Set playground links]
            setLinks: function (title) {
                var el = this;
                if (el.links) {
                    var links = JSON.parse(el.links);
                    var fragment = document.createDocumentFragment();
                    for (var key in links) {
                        var link = links[key];

                        if (link.icon && !link.text) {
                            var vicon = document.createElement("app-vicon");
                            vicon.vicon = link.icon;
                            vicon.vtitle = key;
                            vicon.background = "rgba(0,0,0,0.1)";
                            vicon.link = link.link;
                            vicon.addEventListener("click", function (e) {
                                window.open(this.link, '_blank');
                            });
                            fragment.appendChild(vicon);
                        } else {
                            var button = document.createElement("eon-button");
                            button.vicon = "vicon-" + link.icon;
                            button.label = link.text;
                            button.link = link.link;
                            button.addEventListener("click", function (e) {
                                window.open(this.link, '_blank');
                            });
                            fragment.appendChild(button);
                        }
                    }

                    el._refs.links.appendChild(fragment);
                }
            },
            // @function setIframe (public) [Set iframe content]
            setIframe: function () {
                var el = this;
                var parent = el._refs.iframe.parentNode;

                // TODO iframe is created again
                parent.removeChild(el._refs.iframe);
                el._refs.iframe = document.createElement("iframe");
                parent.appendChild(el._refs.iframe);

                var iframeContent = el._refs.iframe.contentWindow.document || el._refs.iframe.contentDocument;
                iframeContent.open();
                iframeContent.write(el._getIframeString());
                iframeContent.close();
                iframeContent.head.appendChild(el._iframeGenericCss());

                // TODO This function load scripts async which could result into a bottle neck
                el._appendScriptsToIframe(iframeContent);

                eon.triggerCallback("onReady", el, el, [el._refs.iframe]);
                el._refs.iframe.classList.remove("app-playground-hidden");
                el._refs.loading.hide();
            },
            // @function toggle (public) [Switch code and result view] @param-optional view [Force toggle to one specific (result/code)]
            toggle: function (view) {
                var el = this;
                el._refs.fading.start();
                if (view) {
                    switch (view) {
                        case "result":
                            el._goToResult();
                            break;
                        case "code":
                            el._goToCode();
                            break;
                    }
                } else {
                    switch (el._misc.activeView) {
                        case "code":
                            el._goToResult();
                            break;
                        case "result":
                            el._goToCode();
                            break;
                    }
                }
            },
            // @function fullscreen (public) [Switch fullscreen view]
            toggleFullscreen: function () {
                var el = this;
                if (el._misc.isFullscreen) {
                    el.goToDefaultView();
                } else {
                    el.goToFullscreen();
                }
            },
            // @function goToFullscreen (public) [Open fullscreen view]
            goToFullscreen: function () {
                var el = this;
                el._refs.fullscreen.vicon = "fullscreen-exit";
                el.style.height = "100%";
                el.style.width = "100%";
                el.style.position = "fixed";
                el.style.top = "0px";
                el.style.left = "0px";
                el.style.zIndex = "9999";
                el._misc.parent = el.parentNode;
                el._misc.nextSibling = el.nextSibling;
                document.body.appendChild(el);
                eon.triggerCallback("onFullScreenActivated", el, el);
                if (el._misc.activeView == "result") {
                    el.setIframe(); // TODO iframe needs to be reset after changing parent. It shouldn't be needed.
                }
                el._misc.isFullscreen = true;
            },
            // @function goToDefaultView (public) [Open playground in default size]
            goToDefaultView: function () {
                var el = this;
                el._refs.fullscreen.vicon = "fullscreen";
                el.style = "";
                if (el._misc.nextSibling) {
                    el._misc.parent.insertBefore(el, el._misc.nextSibling);
                } else {
                    el._misc.parent.appendChild(el);
                }
                if (el._misc.activeView == "result") {
                    el.setIframe(); // TODO iframe needs to be reset after changing parent. It shouldn't be needed.
                }
                eon.triggerCallback("onFullScreenDeactivated", el, el);
                el._misc.isFullscreen = false;
            }
        },

        privateFunctions: {
            // @function _init (private) [Initialize component]
            init: function () {
                var el = this;
                el._setUpRefs();
                el._setUp();
            },
            // @function _setUpRefs (private) [Set up references]
            setUpRefs: function () {
                var el = this;
                el._refs.title = el.querySelector(".app-playground-menu-title");
                el._refs.iframe = el.querySelector("iframe");
                el._refs.editor = el.querySelector("eon-editor");
                el._refs.loading = el.querySelector(".app-playground-loading");
                el._refs.toggle = el.querySelector(".app-playground-toggle");
                el._refs.fullscreen = el.querySelector(".app-playground-fullscreen");
                el._refs.tabs = el.querySelector(".app-playground-menu-tabs");
                el._refs.links = el.querySelector(".app-playground-menu-links");
                el._refs.fading = el.querySelector("app-fading");
            },
            // @function _setUp (private) [Set up component]
            setUp: function () {
                var el = this;
                el._misc.activeView = "result";
                el._misc.editorSet = false;
                el._refs.editor.readonly = el.readonly;
                el._misc.isFullscreen = false;
                el.scripts = el.scripts ? Array.isArray(el.getAttribute("scripts").split(",")) ? el.getAttribute(
                    "scripts").split(",") : [] : "";
                el.components = el.components ? Array.isArray(el.getAttribute("components").split(",")) ? el.getAttribute(
                    "components").split(
                    ",") : [] : "";
                el.setTitle();
                el.setIframe();
                el.setLinks();
                el._refs.toggle.addEventListener("click", function (e) {
                    el.toggle();
                });
                el._refs.fullscreen.addEventListener("click", function (e) {
                    el.toggleFullscreen();
                });
            },
            // @function _storeCode (private) [Take code from inner and from html attributes]
            storeCode: function () {
                var el = this;
                var sourceCode = el.getSourceElements();
                el._misc.code = {};
                sourceCode.forEach(function (code) {
                    switch (code.getAttribute("type")) {
                        case "html":
                            el._misc.code.html = code.innerHTML;
                            break;
                        case "js":
                            el._misc.code.js = code.innerHTML;
                            break;
                        case "css":
                            el._misc.code.css = code.innerHTML;
                            break;
                    }
                    code.parentNode.removeChild(code);
                });
                el.onReady(function () {
                    el._misc.code.html = el._misc.code.html || el.html || el.getAttribute("html") ||
                        null;
                    el._misc.code.js = el._misc.code.js || el.js || el.getAttribute("js") || null;
                    el._misc.code.css = el._misc.code.css || el.css || el.getAttribute("css") ||
                        null;
                });
            },
            // @function _getIframeString (private) [Format code into a string to be written at iframe]
            getIframeString: function () {
                var el = this;
                var headReg = new RegExp("<head>([\\s\\S])*<\\/head>", "gm");
                var bodyReg = new RegExp("<body>([\\s\\S])*<\\/body>", "gm");
                var headMatches = el._misc.code.html.match(headReg);
                var bodyMatches = el._misc.code.html.match(bodyReg);
                var head = headMatches ? el._cleanMatch(headMatches[0], "<head>", "</head>") : null;
                var body = bodyMatches ? el._cleanMatch(bodyMatches[0], "<body>", "</body>") :
                    null || el._misc.code.html;
                var iframeSrc = "<!DOCTYPE html><html><head>";
                if (head) {
                    iframeSrc += head;
                }
                iframeSrc += "<style>";
                iframeSrc += el._misc.code.css;
                iframeSrc += "</style>";
                iframeSrc += "</head><body>" + body;
                iframeSrc += "<script>";
                iframeSrc += el._misc.code.js;
                iframeSrc += "<\/script>";
                iframeSrc += "</body></html>";
                return iframeSrc;
            },
            // @function _cleanMatch (private) {string} @param match @param open [Open tag] @param close [Close tag]
            cleanMatch: function (match, open, close) {
                match = match.trim();
                match = match.substring(open.length, match.length - close.length).trim();
                return match;
            },
            // @function _loadEditor (private) [Load editor if not and set up content]
            loadEditor: function () {
                var el = this;
                if (!el._misc.editorSet) {
                    if (!eon.util.isTrue(el._refs.editor.isReady)) {
                        el._refs.editor.onloader(function () {
                            el._refs.editor._init();
                        });
                    }
                    el._setupEditor();
                    el._misc.editorSet = true;
                }
            },
            // @function _setupEditor (private) [Set up editor for the first time. Set up tabs before set content]
            setupEditor: function () {
                var el = this;
                var tabsCount = el._tabsCount();
                if (el._misc.code.html) {
                    var htmlTabBttn = document.createElement("div");
                    htmlTabBttn.classList.add("app-playground-menu-tabs-bttn");
                    htmlTabBttn.type = "html";
                    htmlTabBttn.innerText = "Html";
                    if (tabsCount == 1) {
                        htmlTabBttn.classList.add("app-playground-hidden");
                    }
                    htmlTabBttn.addEventListener("click", function (e) {
                        el._selectTab(htmlTabBttn);
                    });
                    el._selectTab(htmlTabBttn);
                    if (tabsCount == 1) {
                        htmlTabBttn.classList.add("app-playground-hidden");
                    }
                    el._refs.tabs.appendChild(htmlTabBttn);
                }
                if (el._misc.code.js) {
                    var jsTabBttn = document.createElement("div");
                    jsTabBttn.classList.add("app-playground-menu-tabs-bttn");
                    if (!el._misc.code.html) {
                        jsTabBttn.classList.add("app-playground-menu-tabs-bttn-selected");
                        el._selectTab(jsTabBttn);
                    }
                    jsTabBttn.type = "js";
                    jsTabBttn.innerText = "Js";
                    jsTabBttn.addEventListener("click", function (e) {
                        el._selectTab(jsTabBttn);
                    });
                    if (jsTabBttn == 1) {
                        htmlTabBttn.classList.add("app-playground-hidden");
                    }
                    el._refs.tabs.appendChild(jsTabBttn);
                }
                if (el._misc.code.css) {
                    var cssTabBttn = document.createElement("div");
                    cssTabBttn.classList.add("app-playground-menu-tabs-bttn");
                    cssTabBttn.type = "css";
                    cssTabBttn.innerText = "Css";
                    cssTabBttn.addEventListener("click", function (e) {
                        el._selectTab(cssTabBttn);
                    });
                    if (tabsCount == 1) {
                        cssTabBttn.classList.add("app-playground-hidden");
                    }
                    el._refs.tabs.appendChild(cssTabBttn);
                }
            },
            // @function _tabsCount (private) {int} [Return how many code tabs should be]
            tabsCount: function () {
                var el = this;
                var count = 0;
                if (el._misc.code.html) {
                    count++;
                }
                if (el._misc.code.js) {
                    count++;
                }
                if (el._misc.code.css) {
                    count++;
                }
                return count;
            },
            // @function _selectTab (private) [Select given code tab]
            selectTab: function (tab) {
                var el = this;
                if (el._misc.selectedTab) {
                    switch (el._misc.selectedTab.type) {
                        case "html":
                            el._misc.code.html = el._htmlFilterReverse();
                            break;
                        case "js":
                            el._misc.code.js = el._refs.editor.getValue();
                            break;
                        case "css":
                            el._misc.code.css = el._refs.editor.getValue();
                            break;
                    }
                }
                switch (tab.type) {
                    case "html":
                        el._refs.editor.setValue(el._htmlFilter());
                        break;
                    case "js":
                        el._refs.editor.setValue(el._misc.code.js);
                        break;
                    case "css":
                        el._refs.editor.setValue(el._misc.code.css);
                        break;
                }
                el._refs.editor.language = tab.type;
                if (el._misc.selectedTab) {
                    el._misc.selectedTab.classList.remove("app-playground-menu-tabs-bttn-selected");
                }
                el._misc.selectedTab = tab;
                el._misc.selectedTab.classList.add("app-playground-menu-tabs-bttn-selected");
                setTimeout(function () {
                    if (eon.util.isTrue(el.format)) {
                        el._refs.editor.format();
                    }
                }, 0);
            },
            // @function _goToResult (private) [Show result view]
            goToResult: function () {
                var el = this;
                el._refs.iframe.classList.remove("app-playground-hidden");
                el._refs.editor.classList.add("app-playground-hidden");
                el._misc.activeView = "result";
                if (el._misc.selectedTab) {
                    switch (el._misc.selectedTab.type) {
                        case "html":
                            el._misc.code.html = el._htmlFilterReverse();
                            break;
                        case "js":
                            el._misc.code.js = el._refs.editor.getValue();
                            break;
                        case "css":
                            el._misc.code.css = el._refs.editor.getValue();
                            break;
                    }
                }
                el._refs.tabs.classList.add("app-playground-hidden");
                el._refs.toggle.vtitle = "go to code";
                el.setIframe();
            },
            // @function _goToCode (private) [Show code view]
            goToCode: function () {
                var el = this;
                el._refs.iframe.classList.add("app-playground-hidden");
                el._refs.editor.classList.remove("app-playground-hidden");
                el._misc.activeView = "code";
                el._refs.tabs.classList.remove("app-playground-hidden");
                el._refs.toggle.vtitle = "go to result";
                el._loadEditor();
            },
            // @function _htmlFilter (private) [Filter html if selector attribute is set]
            htmlFilter: function () {
                var el = this;
                if (el.selector && el.selector != "") {
                    var html = document.createElement('html');
                    html.innerHTML = el._misc.code.html;
                    return html.querySelector(el.selector).innerHTML;
                }
                return el._misc.code.html;
            },
            // @function _htmlFilterReverse (private) [Reverse filtered html to set at the iframe]
            htmlFilterReverse: function () {
                var el = this;
                if (el.selector && el.selector != "") {
                    var html = document.createElement('html');
                    html.innerHTML = el._misc.code.html;
                    html.querySelector(el.selector).innerHTML = el._refs.editor.getValue();
                    return html.innerHTML;
                }
                return el._refs.editor.getValue();
            },
            // @function _iframeGenericCss (private) [Css code added to any iframe]
            iframeGenericCss: function () {
                var el = this;
                var genericCss = document.createElement("style");
                genericCss.id = "genericCss";
                var fullcss = "";
                var htmlBody = " html,body{height:100%; width:100%; margin: 0px;";
                fullcss += htmlBody;
                genericCss.innerHTML = fullcss;
                return genericCss;
            },
            // @function _appendScriptsToIframe (private) [Append scripts to iframe head] @param iframeContent
            appendScriptsToIframe: function (iframeContent) {
                var el = this;
                var scriptsToLoad = el._iframeGenericJs();

                // @function _appendJs (private) [Recursive call to load scripts within _appendScriptsToIframe function] @param script
                function appendJs(script) {
                    script.addEventListener('load', function () {
                        var currentScript = scriptsToLoad.shift();
                        if (currentScript) {
                            appendJs(currentScript);
                        }
                    });
                    iframeContent.head.appendChild(script);
                }

                iframeContent.head.appendChild(scriptsToLoad.shift());
                appendJs(scriptsToLoad.shift());
            },
            // @function _iframeGenericJs (private) [Js code added to any iframe]
            iframeGenericJs: function () {
                var el = this;
                var result = [];
                var themeJs = document.createElement("script");
                themeJs.innerHTML = "var eon = { theme: 'claro' };";
                result.push(themeJs);
                if (el.scripts.length > 0) {
                    el.scripts.forEach(function (src) {
                        var script = document.createElement("script");
                        script.src = src;
                        result.push(script);
                    });
                }
                var componentsJs = document.createElement("script");
                componentsJs.innerHTML = "";
                if (el.components.length > 0) {
                    var imp = "eon.import([";
                    el.components.forEach(function (component) {
                        imp += "'" + component + "',";

                    });
                    imp = imp.substring(0, imp.length - 1); // Remove last coma.
                    imp += "]);";
                    componentsJs.innerHTML += imp;
                }
                result.push(componentsJs);
                return result;
            }
        },

        onCreated: function () {
            var el = this;
            el._storeCode();
            eon.createCallback("onReady", this, "ready");
            eon.createCallback("onFullScreenActivated", this);
            eon.createCallback("onFullScreenDeactivated", this);
        },


        onReady: function () {
            var el = this;
            setTimeout(() => { // Delay init because _storeCode wait for ready and needs to be triggered before init call.
                el._init();
            }, 0);
        },


    });
</script>