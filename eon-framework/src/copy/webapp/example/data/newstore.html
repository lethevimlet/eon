<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">

  <!-- Import VimletJS  -->
  <title>EON STORE</title>
  <script src="/eon/eon.js"></script>

  <!-- Example style -->
  <link rel="stylesheet" href="/example/data/css/style.css">
  <link rel="stylesheet" href="/example/data/css/store.css">


  <!-- UI components -->
  <script>
    eon.import([
      "/eon/ui/eon-text",
      "/eon/ui/eon-scroll"
    ]);
  </script>

</head>

<body>

  <div class="container">
    <div class="card">
      <h1>MEMORY</h1>

      <div class="row">

        <button onclick="get()">
          READ
        </button>
        <button onclick="create()">
          CREATE
        </button>
        <button onclick="update()">
          UPDATE
        </button>
        <button onclick="deletion()">
          DELETE
        </button>

      </div>
      <div class="twoRows">
        <div class="twoColumns" style="margin-bottom: 6px;">

          <div class="example twoRows">
            <h4 class="title">REQUEST</h4>
            <h5 class="title">ID</h5>
            <eon-text class="subCard input" inline="false" style="margin-bottom: 10px;" id="id">
            </eon-text>
            <h5 class="title">JSON</h5>
            <eon-text class="subCard" style="font-family: monospace;" inline="false" type="area" id="json" area-height="200">
            </eon-text>
          </div>
          <div class="example">
            <h4 class="title">DATA</h4>
            <pre class="flexStretch" id="data"></pre>
          </div>

        </div>
        <div style="padding: 5px">
          <div class="example twoRows">
            <h4 class="title">RESULT</h4>
            <h5 id="requestType" class="subTitle"></h5>
            <pre id="result" class="flexStretch"></pre>
          </div>
        </div>
      </div>
    </div>


    <!-- eon store usage -->
    <script>

      // Fields
      var entryId = document.querySelector("#id");
      var jsonField = document.querySelector("#json");
      var dataField = document.querySelector("#data");
      var requestType = document.querySelector("#requestType");
      var resultField = document.querySelector("#result");

      // Store object
      var store = new eon.store();

      // Get example data json
      var endpoint = new eon.endpoint("rest", "util/store/data.json");
      endpoint.get("", function (error, data) {
        store.onLoaded(function () {
          // Set store data
          store.data = eon.util.arrayToMap(JSON.parse(data.responseText));
          // Fill data field
          dataField.innerHTML = data.responseText;
        });
      });

      // -- MEMORY EXAMPLE API --
      // :: READ
      function get() {
        var result;
        // Remove spaces
        entryId.value = entryId.value.replace(/\s/g, '');
        // Get entry id
        var id = !entryId.value ? null : entryId.value;
        requestType.innerHTML = "Get request";
        // Store read
        store.read(id).result(function (error, data) {
          if (error) { console.error(error); return false; }

          result = data;
          if (data instanceof Map) {
            result = eon.util.mapToObject(data);
          }
          resultField.innerHTML = JSON.stringify(result, null, 2);
        });
      }
      // :: CREATE
      function create() {
        var item = jsonField.value;
        try {
          item = JSON.parse(item);
          requestType.innerHTML = "Create request";
          // Store create
          store.create(item).result(function (error, data) {
            if (error) { console.error(error); return false; }

            resultField.innerHTML = JSON.stringify(data, null, 2);
            // Refresh data field
            refreshData(dataField, eon.util.mapToObject(store.data));
          });
        } catch (err) {
          console.warn("Example warning: Invalid json format")
        }
      }
      // :: UPDATE
      function update() {
        var item = jsonField.value;
        // Remove spaces
        entryId.value = entryId.value.replace(/\s/g, '');
        // Get entry id
        var id = !entryId.value ? null : entryId.value;
        try {
          item = JSON.parse(item);
          requestType.innerHTML = "Update request";
          // Store update
          store.update(id, item).result(function (error, data) {
            if (error) { console.error(error); return false; }

            resultField.innerHTML = JSON.stringify(data, null, 2);
            // Refresh data field
            refreshData(dataField, eon.util.mapToObject(store.data));
          });
        } catch (err) {
          console.warn("Example warning: Invalid json format")
        }
      }
      // :: DELETE
      function deletion() {
        // Remove spaces
        entryId.value = entryId.value.replace(/\s/g, '');
        // Get entry id
        var id = !entryId.value ? null : entryId.value;
        requestType.innerHTML = "Remove request";
        // Store update
        store.delete(id).result(function (error, data) {
          if (error) { console.error(error); return false; }

          resultField.innerHTML = JSON.stringify(data, null, 2);
          // Refresh data field
          refreshData(dataField, eon.util.mapToObject(store.data));
        });
      }

      /*
      * Update data field
      */
      function refreshData(el, data) {
        el.innerHTML = JSON.stringify(data, null, 2);
      }

    </script>
</body>

</html>