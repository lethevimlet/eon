<template>
  <div class="eon-viewer-views">
    <div class="eon-viewer-view eon-viewer-example">
    </div>
    <div class="eon-viewer-view eon-viewer-showcase">
    </div>
    <div class="eon-viewer-edit eon-fg2-hoverable">Toggle playground</div>
  </div>
</template>

<script type="text/javascript">
  eon.element({

    name: "eon-viewer",
    style: "eon-viewer.css",

    themed: true,

    properties: {
      /*
       @property {String} type
       @description 
     */
      type: {
        value: "",
        reflect: true
      },
      /*
       @property {String} load
       @description 
     */
      load: {
        value: {},
        reflect: true
      }
    },

    privateProperties: {
      /*
        @property (private) {Object} _refs 
        @description Object with references
      */
      refs: {
        value: {}
      },
      /*
        @property (private) {Object} _misc
        @description 
      */
      misc: {
        value: {}
      }
    },

    functions: {},

    privateFunctions: {
      /*
        @function (private) _setUpRefs
        @description 
      */
      setUpRefs: function () {
        var el = this;
        el._refs.views = el.template.querySelector(".eon-viewer-views");
        el._refs.example = el.template.querySelector(".eon-viewer-example");
        el._refs.showcaseContainer = el.template.querySelector(".eon-viewer-showcase");
        el._refs.showcaseFragment = document.createDocumentFragment();
        el._refs.edit = el.template.querySelector(".eon-viewer-edit");
      },
      /*
        @function (private) _setUpExample
        @description 
      */
      setUpExample: function (nodes) {
        var el = this;
        // Show example view
        el._refs.example.classList.add("eon-viewer-view-visible");
        // Move example nodes to the wrapper element safely
        while (nodes.length) {
          // From first to last...
          el._refs.example.appendChild(nodes.shift());
        }
      },
      /*
        @function (private) _setUpShowcase
        @description 
      */
      setUpShowcase: function (nodes) {
        var el = this;
        // Move example nodes to the wrapper element safely
        while (nodes.length) {
          // From first to last...
          el._refs.showcaseFragment.appendChild(nodes.shift());
        }
      },
      /*
        @function (private) _injectContent
        @description 
      */
      injectContent: function () {
        var el = this;
        var children = el.getSourceElements();
        var exampleNodes = [].slice.call(children[0].children);
        var showcaseNodes = [].slice.call(children[1].children);

        el._setUpExample(exampleNodes);
        el._setUpShowcase(showcaseNodes);
      },
      /*
       @function (private) _setUpEdit
       @description 
     */
      setUpEdit: function () {
        var el = this;
        if (eon.util.getBrowser() !== "IE") {
          el._refs.edit.addEventListener("click", function (e) {
            // Append showcase
            el._refs.showcase = el._refs.showcaseFragment.querySelector("eon-showcase");
            el._refs.showcaseContainer.appendChild(el._refs.showcaseFragment);
            el._refs.showcaseContainer.style.height = (el.offsetHeight + 30) + "px";
            // Display showcase HTML tab
            el._refs.showcase.onReady(function () {
              el._refs.showcase._refs.tabs.onReady(function () {
                el._refs.showcase._refs.tabs.select("html");
              });
            });
            // On showcase load callback
            eval(el.load);
            // Hide example view
            el._refs.example.classList.remove("eon-viewer-view-visible");
            el._refs.showcaseContainer.classList.add("eon-viewer-view-visible");
            el._refs.edit.style.display = "none";
          }, false);
        } else {
          el._refs.edit.style.display = "none";
        }
      },
      /*
       @function (private) _removeResidualNodes
       @description 
     */
      removeResidualNodes: function () {
        var el = this;
        // Remove residual nodes
        el.removeChild(el.children[el.children.length - 1]);
        el.removeChild(el.children[el.children.length - 1]);
      }
    },

    onCreated: function () {
      var el = this;

      el._refs.wrapper = el.template.querySelector(".eon-viewer-views");
    },
    onInit: function () {
      var el = this;
      el._setUpRefs();
      el._injectContent();
      el._setUpEdit();
    },
    onTransformed: function () {
      var el = this;
      el._removeResidualNodes();
    }

  });
</script>