<template>

  <div class="vc-tabs-closeButton">
    <i class="iconsSize material-icons vc-fg5 vc-fg1-hoverable">close</i>
  </div>
  <span class="vc-tabs-title vc-fg5 vc-fg2-hoverable">template</span>

</template>

<script type="text/javascript">
  vcomet.element("vc-tab", null, {
    properties: {
      name: {
        value: "",
        reflect: true
      },
      host: {
        value: {}
      }
    },
    privateProperties: {
      refs: {
        value: {}
      }
    },
    privateFunctions: {

      assignAttributes: function () {

        var el = this;

        var name = el.getAttribute("name");
        var tempId = name + "Tab";
        var definitiveName = name;
        var differentiatorNumber = 2;
        
        if (tempId in el._refs.host._misc.contents) {

          while (tempId in el._refs.host._misc.contents) {

            tempId = name + differentiatorNumber + "Tab";
            definitiveName = name + differentiatorNumber;
            differentiatorNumber++;
          }
        }

        if (!el.getAttribute("title")) {
          el.setAttribute("title", el.getAttribute("name"));
        }

        el.setAttribute("name", definitiveName);
        el.setAttribute("data-selected", "false");
        el.setAttribute("id", definitiveName + "Tab");

      },

      assignOrder: function () {

        var el = this;

        var tabs = el.parentNode;
        var tabsCount = el._refs.host._refs.tabsWrapper.querySelectorAll("vc-tab").length;

        if (tabsCount) {

          for (var i = 0; i < tabsCount; i++) {

            if (!tabs.querySelector('vc-tab[data-tab-order="' + i + '"]')) {
              el.dataset.tabOrder = i;
              break;
            }

          }

        } else {

          el.dataset.tabOrder = 0;

        }

      },

      setupEvents: function () {

        var el = this;

        // Assigns an event for the tab when clicked
        el.addEventListener('click', function (e) {
          el._refs.host.select(el);
          el._refs.contentPanel.render();
        }, false);

        // Creates the close button event
        el.querySelector(".vc-tabs-closeButton").addEventListener('click', function (e) {
          el._refs.host.closeTab(tab, e)
        }, false);

        // Check if we need to assign dragging related events
        if (el._refs.host.getAttribute("dragging") != "false") {

          el.setAttribute("draggable", "true");

          //Adding the draggable functionality, there are more available functions, but these are the ones we need
          el.addEventListener('dragstart', function (e) {
            el._refs.host._handleDragStart(e, tab);
          });

          el.addEventListener("dragend", function (e) {
            el._refs.host._handleDragEnd(e, tab);
          });
        }

      },

      setupContent: function () {

        var el = this;

        var sourceNodes = el.getSourceElements();
        var mainContentsContainer = el._refs.host._refs.contentsWrapper;
        var contentId = el.getAttribute("name") + "Content";

        var contentPanel = document.createElement('vc-panel');
        var contentTemplate = document.createElement('template');

        var sourceFragment = document.createDocumentFragment();
        var node;

        contentPanel.onBubbleRender(function () {
          tab._refs.scroll = contentPanel._refs.wrapper;
        });

        //Configuring content
        contentPanel.id = contentId;
        contentPanel.classList.add("vc-tabs-content", "vc-fg3", "selectable", "hidden");
        contentPanel.setAttribute("visible", "false");

        // Appending source nodes to the content
        while (sourceNodes.length) {
          // From first to last...
          node = sourceNodes.shift();
          sourceFragment.appendChild(node);
        }

        contentTemplate.appendChild(sourceFragment);
        contentPanel.appendChild(contentTemplate);

        mainContentsContainer.appendChild(contentPanel);

        el._refs.host._misc.contents[el.id] = contentId;
        el._refs.contentPanel = contentPanel;

      }

    },
    //Here we will just move the tab content to a template before its transformed
    onInit: function () {
      this._refs.host = this.parentNode;
    },
    onRender: function () {

      var tab = this;
      var tabTitleElement = tab.querySelector(".vc-tabs-title");


      var mainTabsContainer = tab._refs.host._refs.tabsWrapper;


      
      tab.classList.add("vc-bg4-border");

      tab._assignAttributes();
      tab._assignOrder();

      tab._setupContent();
      tab._setupEvents();

      tabTitleElement.innerHTML = tab.getAttribute("title");

      mainTabsContainer.appendChild(tab);

      tab._refs.host._handleTabsScrollsStatus();

      if (tab.dataset.tabOrder == 0) {
        tab._refs.host.onReady(function () {
          tab._refs.host._selectTab(tab);
          tab._refs.contentPanel.render();
        });
      }

      // After a tab has been added, we append again the dropArea so its always on top of the tabs as its always the lastChild
      tab._refs.host.onRender(function () {
        tab._refs.host._refs.tabsWrapper.appendChild(tab._refs.host._misc.dragging.dropArea);
      });


    }
  });
</script>