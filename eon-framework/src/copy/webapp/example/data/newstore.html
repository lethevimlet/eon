<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">

  <!-- Import VimletJS  -->
  <title>EON STORE</title>
  <script src="/eon/eon.js"></script>

  <!-- Example style -->
  <link rel="stylesheet" href="/example/data/css/style.css">
  <link rel="stylesheet" href="/example/data/css/store.css">


  <!-- UI components -->
  <script>
    eon.import([
      "/eon/ui/eon-text",
      "/eon/ui/eon-checkbox",
      "/eon/ui/eon-scroll"
    ]);
  </script>

</head>

<body>

  <div class="container">
    <div class="card">
      <h1>MEMORY</h1>

      <div class="row">

        <button onclick="get()">
          READ
        </button>
        <button onclick="create()">
          CREATE
        </button>
        <button onclick="update()">
          UPDATE
        </button>
        <button onclick="deletion()">
          DELETE
        </button>

      </div>
      <div class="twoRows">
        <div class="twoColumns" style="margin-bottom: 6px;">

          <div class="example twoRows">
            <h4 class="title">REQUEST</h4>
            <eon-text class="subCard input" inline="false" label="ID" 
                      style="margin-bottom: 10px;" id="id">
            </eon-text>
            <eon-text class="subCard" style="font-family: monospace;" label="JSON" 
                      inline="false" type="area" id="json" area-height="200">
            </eon-text>
          </div>
          <div class="example">
            <h4 class="title">DATA</h4>
            <eon-scroll class="flexStretch" thickness="8">
              <pre id="data"></pre>
            </eon-scroll>
          </div>

        </div>
        <div style="padding: 5px">
          <div class="example twoRows">
            <h4 class="title">RESULT</h4>
            <h5 id="requestType" class="subTitle"></h5>
            <eon-scroll class="flexStretch resultClass" thickness="8">
              <pre id="result"></pre>
            </eon-scroll>
          </div>
        </div>
      </div>

      <div class="row">

        <button onclick="range()">
          RANGE
        </button>
        <button onclick="sort()">
          SORT
        </button>
        <button onclick="rangeSorted()">
          RANGE SORTED
        </button>

      </div>

      <div class="twoRows">
        <div class="twoColumns" style="margin-bottom: 6px;">

          <div class="example twoRows">
            <h4 class="title">REQUEST</h4>
            <eon-text class="subCard input" inline="false" style="margin-bottom: 10px;" 
                      id="keyField" label="Key">
            </eon-text>
            <eon-checkbox class="subCard input" style="margin-bottom: 10px; width: 19px; margin-bottom: 15px;"
                          id="descField" label="Descending">
            </eon-checkbox>
            <eon-text class="subCard" style="margin-bottom: 10px;" inline="false" 
                      id="startField" label="Start">
            </eon-text>
            <eon-text class="subCard" style="margin-bottom: 10px;" inline="false" 
                      id="limitField" label="Limit">
            </eon-text>
          </div>
          <div class="example">
            <h4 class="title">DATA</h4>
            <eon-scroll class="flexStretch" fill="true" thickness="8">
              <pre id="advData"></pre>
            </eon-scroll>
          </div>

        </div>
        <div style="padding: 5px">
          <div class="example twoRows">
            <h4 class="title">RESULT</h4>
            <h5 id="advRequestType" class="subTitle"></h5>
            <eon-scroll class="flexStretch resultClass" fill="true" thickness="8">
              <pre id="advResult"></pre>
            </eon-scroll>
          </div>
        </div>
      </div>

    </div>


    <!-- eon store usage -->
    <script>

      // References
      var entryId, jsonField, dataField, requestType, resultField, keyField, descField,
      startField, limitField, advData, advRequestType, advResult, store;

      // Wait for eon 
      eon.onReady(function(){
        // Fields
        entryId = document.querySelector("#id");
        jsonField = document.querySelector("#json");
        dataField = document.querySelector("#data");
        requestType = document.querySelector("#requestType");
        resultField = document.querySelector("#result");
        resultScroll = document.querySelector(".resultClass");
        // Advanced fields
        keyField = document.querySelector("#keyField");
        descField = document.querySelector("#descField");
        startField = document.querySelector("#startField");
        limitField = document.querySelector("#limitField");
        advData = document.querySelector("#advData");
        advRequestType = document.querySelector("#advRequestType");
        advResult = document.querySelector("#advResult");
        advResultScroll = document.querySelectorAll(".resultClass")[1];

        //** Remove weird spaces from eon-text elements
        removeTextsSpaces();

        // Store object
        store = new eon.store();
  
        // Get example data json
        var endpoint = new eon.endpoint("rest", "util/store/data.json");
        endpoint.get("", function (error, data) {
          store.onLoaded(function () {
            // Set store data
            store.data = eon.util.arrayToMap(JSON.parse(data.responseText));
            // Fill data field
            dataField.innerHTML = data.responseText;
            advData.innerHTML = data.responseText;
          });
        });
      });

      // -- MEMORY EXAMPLE API --
      // :: READ
      function get() {
        var result;
        // Remove spaces
        entryId.value = entryId.value.replace(/\s/g, '');
        // Get entry id
        var id = !entryId.value ? null : entryId.value;
        requestType.innerHTML = "Get request";
        // Store read
        store.read(id).result(function (error, data) {
          if (error) { console.error(error); return false; }

          result = data;
          if (data instanceof Map) {
            result = eon.util.mapToObject(data);
          }
          resultField.innerHTML = JSON.stringify(result, null, 2);
          resizeResult(resultScroll);
        });
      }
      // :: CREATE
      function create() {
        var item = jsonField.value;
        try {
          item = JSON.parse(item);
          requestType.innerHTML = "Create request";
          // Store create
          store.create(item).result(function (error, data) {
            if (error) { console.error(error); return false; }

            resultField.innerHTML = JSON.stringify(data, null, 2);
            // Refresh data field
            refreshData(dataField, eon.util.mapToObject(store.data));
            resizeResult(resultScroll);
          });
        } catch (err) {
          console.warn("Example warning: Invalid json format")
        }
      }
      // :: UPDATE
      function update() {
        var item = jsonField.value;
        // Remove spaces
        entryId.value = entryId.value.replace(/\s/g, '');
        // Get entry id
        var id = !entryId.value ? null : entryId.value;
        try {
          item = JSON.parse(item);
          requestType.innerHTML = "Update request";
          // Store update
          store.update(id, item).result(function (error, data) {
            if (error) { console.error(error); return false; }

            resultField.innerHTML = JSON.stringify(data, null, 2);
            // Refresh data field
            refreshData(dataField, eon.util.mapToObject(store.data));
            resizeResult(resultScroll);
          });
        } catch (err) {
          console.warn("Example warning: Invalid json format")
        }
      }
      // :: DELETE
      function deletion() {
        // Remove spaces
        entryId.value = entryId.value.replace(/\s/g, '');
        // Get entry id
        var id = !entryId.value ? null : entryId.value;
        requestType.innerHTML = "Remove request";
        // Store update
        store.delete(id).result(function (error, data) {
          if (error) { console.error(error); return false; }

          resultField.innerHTML = JSON.stringify(data, null, 2);
          // Refresh data field
          refreshData(dataField, eon.util.mapToObject(store.data));
          resizeResult(resultScroll);
        });
      }

      // :: RANGE
      function range() {
        // Remove spaces
        startField.value = startField.value.replace(/\s/g, '');
        limitField.value = limitField.value.replace(/\s/g, '');
        // Get range values
        var start = parseInt(startField.value);
        var limit = parseInt(limitField.value);
        var result;
        advRequestType.innerHTML = "Range request";
        // Store read by range
        store.read().limit(start, limit).result(function (error, data) {
          if (error) { console.error(error); return false; }

          result = data;
          if (data instanceof Map) {
            result = mapToArray(data);
            // Show empty object if no entry exists
            result = !result[0] ? {} : result;
          }
          advResult.innerHTML = JSON.stringify(result, null, 2);
          resizeResult(advResultScroll);
        });
      }

      // :: SORT
      function sort() {
        // Remove spaces
        keyField.value = keyField.value.replace(/\s/g, '');
        descField.value = entryId.value.replace(/\s/g, '');
        // Get sort key and rule
        var key = keyField.value;
        var desc = descField.checked ? "descending" : "ascending";
        var result;
        advRequestType.innerHTML = "Sort request";
        // Store sort
        store.read().sort(key, desc).result(function (error, data) {
          if (error) { console.error(error); return false; }

          result = data;
          if (data instanceof Map) {
            result = mapToArray(data);
            // Show empty object if no entry exists
            result = !result[0] ? {} : result;
          }
          advResult.innerHTML = JSON.stringify(result, null, 2);
          resizeResult(advResultScroll);
        });
      }
      // :: RANGE SORTED
      function rangeSorted() {
        // Remove spaces
        keyField.value = keyField.value.replace(/\s/g, '');
        descField.value = entryId.value.replace(/\s/g, '');
        startField.value = startField.value.replace(/\s/g, '');
        limitField.value = limitField.value.replace(/\s/g, '');
        // Get range values
        var key = keyField.value;
        var desc = descField.checked ? "descending" : "ascending";
        var start = parseInt(startField.value);
        var limit = parseInt(limitField.value);
        var result;
        advRequestType.innerHTML = "Range sorted request";
        // Store range sorted
        store.read().sort(key, desc).limit(start, limit).result(function (error, data) {
          if (error) { console.error(error); return false; }

          result = data;
          if (data instanceof Map) {
            result = mapToArray(data);
            // Show empty object if no entry exists
            result = !result[0] ? {} : result;
          }
          advResult.innerHTML = JSON.stringify(result, null, 2);
          resizeResult(advResultScroll);
        });
      }

      /*
      * Map to array
      */
      function mapToArray(map) {
        var array = [];

        map.forEach(function (value, key, map) {
          array.push(map.get(key));
        });

        return array;
      }
      /*
      * Update data field
      */
      function refreshData(el, data) {
        el.innerHTML = JSON.stringify(data, null, 2);
      }
      /*
      * Remove eon-text value spaces
      */
      function removeTextsSpaces() {
        var text;
        texts = document.querySelectorAll("eon-text");

        for (var i = 0; i < texts.length; i++) {
          text = texts[i];
          if (text.value){
            texts[i].value = texts[i].value.replace(/\s/g, '');
          }
        }
      }
      /*
      * Increase result scroll field height
      */
      function resizeResult(field) {
        field.classList.add("resultScroll");
      }

    </script>
</body>

</html>